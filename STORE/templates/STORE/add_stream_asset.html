{% extends 'MAIN/base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/product_management.css' %}">
    <style>
        .media-item, .version-item {
            border: 1px solid #2a2a2a;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: rgba(30, 30, 30, 0.5);
            position: relative;
        }
        
        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #cc0000;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .section-title {
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        
        .add-btn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 8px 15px;
            margin-bottom: 20px;
            cursor: pointer;
        }
    </style>
{% endblock %}

{% block background %}
    {% include 'MAIN/base_background.html' %}
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <h1 class="user_management-title">Add Stream Asset</h1>
    </div>
    
    <!-- Messages -->
    {% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div class="profile-section">
        <form method="post" enctype="multipart/form-data" class="admin-form">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="name">Asset Name</label>
                <input type="text" id="name" name="name" required class="form-control">
            </div>
            
            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="5" class="form-control"></textarea>
            </div>
            
            <!-- Price field removed -->
            <input type="hidden" id="price" name="price" value="0.00">
            
            <div class="form-group">
                <label for="asset_file">Main Asset File (ZIP)</label>
                <input type="file" id="asset_file" name="main_file" required class="form-control">
                <small>Upload a ZIP file containing all assets</small>
            </div>
            
            <div class="form-group">
                <label for="thumbnail">Main Thumbnail Image</label>
                <input type="file" id="thumbnail" name="thumbnail" class="form-control">
                <small>This will be the primary image displayed</small>
            </div>
            
            <h3 class="section-title">Additional Media</h3>
            <div id="media-container">
                <div class="media-item">
                    <button type="button" class="remove-btn remove-media-btn">×</button>
                    <div class="form-group">
                        <label>Media Type</label>
                        <select name="media_types" class="form-control">
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Media File</label>
                        <input type="file" name="media_files" class="form-control">
                    </div>
                </div>
            </div>
            <button type="button" id="add-media-btn" class="add-btn">Add Media</button>
            
            <h3 class="section-title">Versions (Optional)</h3>
            <div id="versions-container">
                <div class="version-item">
                    <button type="button" class="remove-btn remove-version-btn">×</button>
                    <!-- Version Name field removed -->
                    <input type="hidden" name="version_names" value="Default">
                    <div class="form-group">
                        <label>Version Type</label>
                        <select name="version_types" class="form-control">
                            <option value="static">Static</option>
                            <option value="animated">Animated</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Version File</label>
                        <input type="file" name="version_files" class="form-control">
                    </div>
                </div>
            </div>
            <button type="button" id="add-version-btn" class="add-btn">Add Version</button>
            
            <div class="form-group">
                <label class="checkbox-container">
                    <input type="checkbox" name="is_active" value="true" checked>
                    <span class="checkbox-label">Active</span>
                </label>
                <small>Make this asset immediately available to users</small>
            </div>
            
            <div class="form-actions">
                <a href="{% url 'STORE:stream_asset_management' %}" class="action-button cancel">Cancel</a>
                <button type="submit" class="action-button">Add Asset</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Media handling
        const mediaContainer = document.getElementById('media-container');
        const addMediaBtn = document.getElementById('add-media-btn');
        
        // Add initial event listeners for the remove buttons
        document.querySelectorAll('.remove-media-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (mediaContainer.children.length > 1) {
                    this.closest('.media-item').remove();
                } else {
                    alert('You need at least one media item');
                }
            });
        });
        
        addMediaBtn.addEventListener('click', function() {
            const newItem = document.createElement('div');
            newItem.className = 'media-item';
            newItem.innerHTML = `
                <button type="button" class="remove-btn remove-media-btn">×</button>
                <div class="form-group">
                    <label>Media Type</label>
                    <select name="media_types" class="form-control">
                        <option value="image">Image</option>
                        <option value="video">Video</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Media File</label>
                    <input type="file" name="media_files" class="form-control">
                </div>
            `;
            mediaContainer.appendChild(newItem);
            
            // Add event listener to new remove button
            newItem.querySelector('.remove-media-btn').addEventListener('click', function() {
                if (mediaContainer.children.length > 1) {
                    this.closest('.media-item').remove();
                } else {
                    alert('You need at least one media item');
                }
            });
        });
        
        // Version handling
        const versionsContainer = document.getElementById('versions-container');
        const addVersionBtn = document.getElementById('add-version-btn');
        
        // Add initial event listeners for the remove buttons
        document.querySelectorAll('.remove-version-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (versionsContainer.children.length > 1) {
                    this.closest('.version-item').remove();
                } else {
                    // Clear the file input
                    this.closest('.version-item').querySelector('input[type="file"]').value = '';
                }
            });
        });
        
        addVersionBtn.addEventListener('click', function() {
            const newItem = document.createElement('div');
            newItem.className = 'version-item';
            newItem.innerHTML = `
                <button type="button" class="remove-btn remove-version-btn">×</button>
                <input type="hidden" name="version_names" value="Default">
                <div class="form-group">
                    <label>Version Type</label>
                    <select name="version_types" class="form-control">
                        <option value="static">Static</option>
                        <option value="animated">Animated</option>
                        <option value="video">Video</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Version File</label>
                    <input type="file" name="version_files" class="form-control">
                </div>
            `;
            versionsContainer.appendChild(newItem);
            
            // Add event listener to new remove button
            newItem.querySelector('.remove-version-btn').addEventListener('click', function() {
                if (versionsContainer.children.length > 1) {
                    this.closest('.version-item').remove();
                } else {
                    // Clear the file input
                    this.closest('.version-item').querySelector('input[type="file"]').value = '';
                }
            });
        });
    });
</script>
{% endblock %}