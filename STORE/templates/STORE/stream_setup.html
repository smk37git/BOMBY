{% extends 'MAIN/base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/store_item.css' %}">
    <link rel="stylesheet" href="{% static 'css/stream_asset.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
{% endblock %}

{% block background %}
    {% include 'MAIN/base_background_starry.html' %}
{% endblock %}

{% block content %}
<div class="product-container">
    <!-- Back link -->
    <div class="product-navigation">
        <a href="{% url 'STORE:store' %}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Store
        </a>
    </div>
    
    <!-- Split layout for product -->
    <div class="product-split">
        <!-- Left side: Gallery -->
        <div class="product-gallery-side">
            <div class="product-featured-image">
                <div id="featured-container">
                    <div class="video-container" id="videoContainer" data-src="https://storage.googleapis.com/bomby-user-uploads/stream_assets/media/Bomby_Stream_Setup.mp4">
                        <video id="preloadVideo" style="display:none">
                            <source src="https://storage.googleapis.com/bomby-user-uploads/stream_assets/media/Bomby_Stream_Setup.mp4" type="video/mp4">
                        </video>
                        <img src="" alt="Video thumbnail" class="video-thumbnail" id="videoThumbnail">
                        <div class="placeholder-icon">
                            <i class="fas fa-film"></i>
                        </div>
                        <div class="play-overlay">
                            <div class="play-button">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="gallery-thumbnails">
                <!-- Thumbnails -->
                <div class="thumbnail video-thumb active" 
                     data-media-type="video" 
                     data-src="https://storage.googleapis.com/bomby-user-uploads/stream_assets/media/Bomby_Stream_Setup.mp4">
                    <img src="{% static 'images/stream_setup_1.jpg' %}" alt="Video Thumbnail">
                    <div class="placeholder-icon">
                        <i class="fas fa-film"></i>
                    </div>
                </div>
                <div class="thumbnail" data-media-type="image" data-src="{% static 'images/my_stream_setup_2.jpg' %}">
                    <img src="{% static 'images/my_stream_setup_2.jpg' %}" alt="Gallery Image 2">
                </div>
                <div class="thumbnail" data-media-type="image" data-src="{% static 'images/my_stream_setup_3.jpg' %}">
                    <img src="{% static 'images/my_stream_setup_3.jpg' %}" alt="Gallery Image 3">
                </div>
                <div class="thumbnail" data-media-type="image" data-src="{% static 'images/my_stream_setup_4.jpg' %}">
                    <img src="{% static 'images/my_stream_setup_4.jpg' %}" alt="Gallery Image 4">
                </div>
                <div class="thumbnail" data-media-type="image" data-src="{% static 'images/my_stream_setup_5.jpg' %}">
                    <img src="{% static 'images/my_stream_setup_5.jpg' %}" alt="Gallery Image 5">
                </div>
            </div>

            <div class="gallery-message-button">
                {% if user.is_authenticated %}
                    <a href="{% url 'STORE:message_general' %}" class="gallery-message-btn">
                        <i class="fas fa-comment-alt"></i> MESSAGE ME ABOUT MY SETUP
                    </a>
                {% else %}
                    <a href="{% url 'ACCOUNTS:login' %}?next={% url 'STORE:message_general' %}" class="gallery-message-btn">
                        <i class="fas fa-comment-alt"></i> MESSAGE ME ABOUT THIS SETUP
                    </a>
                {% endif %}
            </div>
        </div>
        
        <!-- Right side: Product info -->
        <div class="product-card">
            <h1 class="product-title">MY CUSTOM SETUP
                <div class="product-status {% if product.is_inactive %}active{% else %}active{% endif %}">
                    {% if product.is_inactive %}ACTIVE{% else %}ACTIVE{% endif %}
                </div>
            </h1>
            <hr class="page-divider"></hr>
            
            <div class="product-features-container">
                <div class="product-features" style="margin-right: 250px;">
                  <h2>FEATURES:</h2>
                  <ul class="features-list">
                    <li>
                      <i class="fas fa-check-circle"></i>
                      Precise Performance Enhancements
                    </li>
                    <li>
                      <i class="fas fa-check-circle"></i>
                      Professional Overlays and Graphics
                    </li>
                    <li>
                      <i class="fas fa-check-circle"></i>
                      Multiple Scenes with High Functionality
                    </li>
                    <li>
                      <i class="fas fa-check-circle"></i>
                      Chatbots / Interactivity / Fluid Transitions
                    </li>
                  </ul>
                </div>
                
                <div class="delivery-badge">
                    <i class="fa-solid fa-star"></i>
                    <span style="font-size: 1rem;">BEST OF THE BEST</span>
                </div>
            </div>

            <div class="product-purchase" style="display: inline-block; text-align: center;">
                <a href="{% url 'STORE:premium_package' %}" class="purchase-btn">WANT A SETUP LIKE THIS?</a>
            </div>
        </div>
    </div>
    
    <!-- Description section moved below gallery and product info -->
    <div class="product-description-section">
        <div class="product-card">
            <div class="product-description">
                <h2 class="heading-with-line">DESCRIPTION</h2>
                
                <p>
                    Lets bring your streaming/recording dreams to life! Message me your thoughts so we can start piecing together your setup!
                    I am a full-time Information Technology student and also a part-time streamer with over 1000+ hours streamed. 
                    I have years of experience on both sides of the playing field. Whether it's configuring the back-end of your setup or helping you attract more views to build your online career!
                    <br>
                    <br>
                    Are you feeling overwhelmed with trying to setup your stream yourself? After consulting with me you will feel confident and have the help you need!
                    <br>
                    <br>
                    Here is a list of the things I can setup and more:
                    <br>
                    <li class="description-text">OBS Stream Setup (Captures, Video Capture Devices, etc...)</li>
                    <li class="description-text">Output Settings (Encoding Settings, Tuning, Knowledge of the different Encoders)</li>
                    <li class="description-text">Best settings for your Computer Specs</li>
                    <li class="description-text">OBS troubleshooting (Video, Audio, etc...) -- Having low FPS issues? Let me fix that!</li>
                    <li class="description-text">Overlay integration (Adding graphics and making them look great!)</li>
                    <li class="description-text">Fluid and CUSTOM source transitions</li>
                    <li class="description-text">Multi-streaming</li>
                    <li class="description-text">Alert Boxes, Widgets, Panels, Sponsor Banners</li>
                    <li class="description-text">Connecting multiple services (Twitch/YouTube/TikTok/etc..) to your OBS!</li>
                    <li class="description-text">Windows/Mac</li>
                    <li class="description-text">Coaching to develop your success!</li>

                    <p class="description-text">Please read the FAQ and MESSAGE me!</p>
                </p>

                <h2 class="heading-with-line">MY CUSTOM SETUP SPECIFICS</h2>
                <p>
                    This is my ultimate setup after being a streamer for many years. It's completely customized specfically for my specifications and needs! From chatbots to fluid animated overlays, it's the ultimate experience for viewers!
                    <br>
                    <li class="description-text"><b>Professional Setup</b> -- My OBS is configured for picture-perfectrecording or streaming while ensuring essential settings are refined for a crystal clear picture.</li>
                    <br>
                    <li class="description-text"><b>Fluid Overlays and Transitions</b> -- Custom made (by Sebe) overlays and transitions designed to evoke my style and allow me to design creative scenes!</li>
                    <br>
                    <li class="description-text"><b>Chatbots and Alerts</b> -- Custom animated alerts and a chatbot customized to promote my socials (YouTube, Discord, Bomby, etc...) + commands for viewers to use and redeem items on stream!</li>
                </p>


                <h2 class="heading-with-line">FAQ</h2>
                <div class="faq-container">
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>Why OBS and not SLOBS or SE.LIVE?</span>
                        </div>
                        <div class="faq-answer">
                            The reason I choose OBS is because it utilizes less performance compared to the rest. Which means more quality for your setup! SLOBS/SE.LIVE require more CPU usage and can actually HARM the value of your stream or recording setup. I will however use SLOBS widgets and overlays by integrating to OBS!
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>What do you mean use OBS with SLOBS integration?</span>
                        </div>
                        <div class="faq-answer">
                            Put simply, I will use SLOBS's many tools to boost OBS's overall quality for a better management and user experience. Things like chatbots, commands, timers, and everything else SLOBS's tools offer! This involves setting them up through menus on SLOBS without explicitly using their program.
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>How did I create the graphics?</span>
                        </div>
                        <div class="faq-answer">
                            I love to take inspiration from other things and twitst them into my own unqiue style. Mainly through using ASCII themes, I just can't get enough of that art style!
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>What is my experience?</span>
                        </div>
                        <div class="faq-answer">
                            I have surrounded my life around my passion for computers and all their components; software, hardware, applications, and more! Through my own journey I have poured countless hours into configuring my own devices and trying my best to always learn more. As a life-longer learner there is no end!
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>Why pick my services over others?</span>
                        </div>
                        <div class="faq-answer">
                            As a streamer myself I understand what it means to have a setup that is new, engaging, and beautiful to attract and retain audiences. With my combined experience of streaming and back-end OBS development I can guarantee great results that cover the entire playing field!
                        </div>
                    </div>
                </div>

                <h2 class="heading-with-line">REVIEWS</h2>
                <div class="reviews-section">
                    {% if product_reviews %}
                        <div class="reviews-list" id="reviewsList">
                            {% for review in product_reviews %}
                            <div class="review-item fade-in">
                                <div class="review-header">
                                    <div class="review-user">
                                        <div class="user-avatar">
                                            {% if review.is_fiverr %}
                                                <div class="avatar-placeholder" style="background: linear-gradient(45deg, #1dbf73, #23e686);">F</div>
                                            {% elif review.order.user.is_staff %}
                                                <div class="private-review-avatar"></div>
                                            {% elif review.order.user.profile_picture and review.order.user.profile_picture.url %}
                                                <img src="{{ review.order.user.profile_picture.url }}" alt="{{ review.order.user.username }}">
                                            {% else %}
                                                <div class="avatar-placeholder">{{ review.order.user.username|first }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="review-user-info">
                                            <div class="username-and-price">
                                                <strong class="username">
                                                    {% if review.is_fiverr %}
                                                        {{ review.fiverr_username }} <span style="font-size: 0.8em; color: #1dbf73;">(Fiverr)</span>
                                                    {% elif review.order.user.is_staff %}
                                                        Private Review
                                                    {% else %}
                                                        {{ review.order.user.username }}
                                                    {% endif %}
                                                </strong>
                                                <span class="order-price">${{ review.order.product.price }}</span>
                                            </div>
                                            <div class="review-rating">
                                                {% for i in "12345" %}
                                                <span class="fa fa-star {% if i|add:'0' <= review.rating %}star-active{% endif %}"></span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="review-date">{{ review.created_at|date:"F j, Y" }}</div>
                                </div>
                                <div class="review-content">
                                    <p class="review-comment">{{ review.comment }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if product_reviews.count > 3 %}
                        <div class="review-pagination">
                            <button id="prevReviews" class="pagination-btn" disabled>
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <div class="pagination-info">
                                <span id="currentPage" style="margin-right: 5px;">1</span> of <span id="totalPages" style="margin-left: 5px;">1</span>
                            </div>
                            <button id="nextReviews" class="pagination-btn">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="no-reviews" style="padding: 1.5rem; margin-bottom: 1.5rem;">
                            <p>No reviews yet for this package. Be the first to leave a review after your purchase!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Global cache to store preloaded videos and thumbnails
        window.videoCache = {};
        
        // Immediately preload all videos
        function preloadAllVideos() {
            // First, identify all video sources
            const videoSources = [];
            
            // Get main featured video if any
            const mainVideoContainer = document.getElementById('videoContainer');
            if (mainVideoContainer) {
                videoSources.push(mainVideoContainer.dataset.src);
            }
            
            // Get all thumbnail videos
            document.querySelectorAll('.thumbnail[data-media-type="video"]').forEach(thumb => {
                videoSources.push(thumb.dataset.src);
            });
            
            // Now preload all videos and generate thumbnails
            videoSources.forEach((src, index) => {
                if (!src || window.videoCache[src]) return; // Skip if already cached
                
                const video = document.createElement('video');
                video.muted = true;
                video.preload = 'auto';
                video.crossOrigin = 'anonymous';
                video.setAttribute('playsinline', true);
                video.setAttribute('webkit-playsinline', true);
                video.style.display = 'none';
                
                // Add to cache first to prevent duplicate processing
                window.videoCache[src] = {
                    video: video,
                    loaded: false,
                    thumbnail: null
                };
                
                // Set video attributes
                const sourceElement = document.createElement('source');
                sourceElement.src = src;
                sourceElement.type = 'video/mp4';
                video.appendChild(sourceElement);
                document.body.appendChild(video);
                
                // Generate thumbnail on metadata load (faster than waiting for full load)
                video.addEventListener('loadeddata', function onDataLoaded() {
                    // Generate thumbnail immediately
                    video.currentTime = 0.1;
                    
                    video.addEventListener('seeked', function onSeeked() {
                        // Create canvas and generate thumbnail
                        const canvas = document.createElement('canvas');
                        // Use small size for efficiency
                        const scale = 0.5;
                        canvas.width = video.videoWidth * scale;
                        canvas.height = video.videoHeight * scale;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        try {
                            // Save thumbnail to cache
                            const dataURL = canvas.toDataURL('image/jpeg', 0.7);
                            window.videoCache[src].thumbnail = dataURL;
                            window.videoCache[src].loaded = true;
                            
                            // Apply thumbnail to all matching elements immediately
                            applyThumbnailToMatchingElements(src, dataURL);
                            
                            // Remove event listener to prevent multiple executions
                            video.removeEventListener('seeked', onSeeked);
                        } catch(e) {
                            console.error("Could not generate thumbnail", e);
                            
                            // If thumbnail generation fails, use the static image
                            const staticImageSrc = "{% static 'images/stream_setup_1.jpg' %}";
                            applyThumbnailToMatchingElements(src, staticImageSrc);
                        }
                    });
                    
                    // Remove event listener
                    video.removeEventListener('loadeddata', onDataLoaded);
                });
                
                video.addEventListener('error', function() {
                    console.error("Error loading video:", src);
                    
                    // Use static image as fallback
                    const staticImageSrc = "{% static 'images/stream_setup_1.jpg' %}";
                    applyThumbnailToMatchingElements(src, staticImageSrc);
                });
                
                // Start loading
                video.load();
            });
        }
        
        // Apply thumbnails to all matching elements
        function applyThumbnailToMatchingElements(videoSrc, thumbnailSrc) {
            // Apply to main video container
            const mainContainer = document.getElementById('videoContainer');
            if (mainContainer && mainContainer.dataset.src === videoSrc) {
                const mainThumb = document.getElementById('videoThumbnail');
                if (mainThumb) {
                    mainThumb.src = thumbnailSrc;
                    mainThumb.style.opacity = 1;
                    
                    // Hide placeholder icon when thumbnail is loaded
                    const placeholderIcon = mainContainer.querySelector('.placeholder-icon');
                    if (placeholderIcon) {
                        placeholderIcon.style.display = 'none';
                    }
                }
            }
            
            // Apply to all matching gallery thumbnails
            document.querySelectorAll(`.thumbnail[data-media-type="video"][data-src="${videoSrc}"] img`).forEach(img => {
                img.src = thumbnailSrc;
                img.style.opacity = 1;
                
                // Hide placeholder icon in thumbnail
                const thumbItem = img.closest('.thumbnail');
                if (thumbItem) {
                    const placeholderIcon = thumbItem.querySelector('.placeholder-icon');
                    if (placeholderIcon) {
                        placeholderIcon.style.display = 'none';
                    }
                }
            });
        }
        
        // Handle click on the video to play immediately
        function setupVideoClickHandlers() {
            // Main video container
            const videoContainer = document.getElementById('videoContainer');
            if (videoContainer) {
                videoContainer.addEventListener('click', function() {
                    const videoSrc = this.dataset.src;
                    const featuredContainer = document.getElementById('featured-container');
                    
                    const videoElement = document.createElement('video');
                    videoElement.setAttribute('controls', true);
                    videoElement.setAttribute('playsinline', true);
                    videoElement.setAttribute('webkit-playsinline', true);
                    videoElement.className = 'featured-image';
                    videoElement.src = videoSrc;
                    
                    // Replace container with video
                    featuredContainer.innerHTML = '';
                    featuredContainer.appendChild(videoElement);
                    
                    // Attempt to play the video
                    const playPromise = videoElement.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log('Auto-play prevented:', error);
                            
                            // Add manual play button for iOS
                            const playButton = document.createElement('div');
                            playButton.style.position = 'absolute';
                            playButton.style.top = '50%';
                            playButton.style.left = '50%';
                            playButton.style.transform = 'translate(-50%, -50%)';
                            playButton.style.zIndex = '10';
                            playButton.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                            playButton.style.color = 'white';
                            playButton.style.borderRadius = '50%';
                            playButton.style.width = '60px';
                            playButton.style.height = '60px';
                            playButton.style.display = 'flex';
                            playButton.style.alignItems = 'center';
                            playButton.style.justifyContent = 'center';
                            playButton.style.cursor = 'pointer';
                            playButton.innerHTML = '<i class="fas fa-play" style="font-size: 24px; margin-left: 5px;"></i>';
                            
                            featuredContainer.appendChild(playButton);
                            
                            playButton.addEventListener('click', function() {
                                videoElement.play()
                                    .then(() => {
                                        this.style.display = 'none';
                                    })
                                    .catch(e => {
                                        console.error('Play failed again:', e);
                                    });
                            });
                        });
                    }
                });
            }
        }
        
        // Handle thumbnail gallery functionality
        function setupGalleryThumbnails() {
            const thumbnails = document.querySelectorAll('.thumbnail');
            const featuredContainer = document.getElementById('featured-container');
            
            thumbnails.forEach(thumbnail => {
                thumbnail.addEventListener('click', function() {
                    // Update active state
                    thumbnails.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const mediaType = this.dataset.mediaType;
                    const mediaSrc = this.dataset.src;
                    
                    if (mediaType === 'video') {
                        // Create video container with preloaded thumbnail
                        const videoContainer = document.createElement('div');
                        videoContainer.className = 'video-container';
                        videoContainer.id = 'videoContainer';
                        videoContainer.dataset.src = mediaSrc;
                        
                        // Create thumbnail image
                        const thumbnail = document.createElement('img');
                        thumbnail.className = 'video-thumbnail';
                        thumbnail.id = 'videoThumbnail';
                        thumbnail.alt = 'Video thumbnail';
                        
                        // Add placeholder icon
                        const placeholderIcon = document.createElement('div');
                        placeholderIcon.className = 'placeholder-icon';
                        placeholderIcon.innerHTML = '<i class="fas fa-film"></i>';
                        
                        // Use cached thumbnail if available
                        if (window.videoCache[mediaSrc] && window.videoCache[mediaSrc].thumbnail) {
                            thumbnail.src = window.videoCache[mediaSrc].thumbnail;
                            thumbnail.style.opacity = 1;
                            placeholderIcon.style.display = 'none';
                        } else {
                            thumbnail.src = "{% static 'images/stream_setup_1.jpg' %}";
                            thumbnail.style.opacity = 1;
                        }
                        
                        // Add play overlay
                        const playOverlay = document.createElement('div');
                        playOverlay.className = 'play-overlay';
                        playOverlay.innerHTML = '<div class="play-button"><i class="fas fa-play"></i></div>';
                        
                        // Assemble container
                        videoContainer.appendChild(thumbnail);
                        videoContainer.appendChild(placeholderIcon);
                        videoContainer.appendChild(playOverlay);
                        
                        // Replace content in featured container
                        featuredContainer.innerHTML = '';
                        featuredContainer.appendChild(videoContainer);
                        
                        // Set up click handler for playing the video
                        setupVideoClickHandlers();
                    } else {
                        // Handle image content
                        const imageElement = document.createElement('img');
                        imageElement.src = mediaSrc;
                        imageElement.alt = 'Featured image';
                        imageElement.className = 'featured-image';
                        imageElement.id = 'featuredImage';
                        
                        featuredContainer.innerHTML = '';
                        featuredContainer.appendChild(imageElement);
                    }
                });
            });
        }
        
        // FAQ functionality
        function setupFAQHandlers() {
            const faqItems = document.querySelectorAll('.faq-item');
            
            faqItems.forEach(item => {
                const question = item.querySelector('.faq-question');
                
                question.addEventListener('click', function() {
                    // Toggle active class
                    item.classList.toggle('active');
                    
                    // Get the chevron container
                    const chevronContainer = this.querySelector('.chevron-container');
                    
                    // Toggle chevron direction
                    if(item.classList.contains('active')) {
                        chevronContainer.innerHTML = '<i class="fas fa-chevron-down"></i>';
                    } else {
                        chevronContainer.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    }
                });
            });
        }
        
        // Format dates to local timezone
        function setupDateFormatting() {
            const formatLocalDate = (dateString) => {
                if (!dateString) return '';
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        return dateString;
                    }
                    return new Intl.DateTimeFormat('en-US', {
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric'
                    }).format(date);
                } catch (e) {
                    return dateString;
                }
            };
            
            // Convert review dates to local timezone
            document.querySelectorAll('.review-date').forEach(element => {
                if (element.textContent.trim()) {
                    element.textContent = formatLocalDate(element.textContent.trim());
                }
            });
        }
        
        // Handle review pagination
        function setupReviewPagination() {
            const reviewItems = document.querySelectorAll('.review-item');
            if (reviewItems.length > 0) {
                const reviewsList = document.getElementById('reviewsList');
                const reviews = Array.from(reviewItems);
                const reviewsPerPage = 5;
                
                // Shuffle array using Fisher-Yates algorithm
                for (let i = reviews.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [reviews[i], reviews[j]] = [reviews[j], reviews[i]];
                }
                
                // Remove all reviews from DOM
                reviews.forEach(review => review.remove());
                
                // Reappend in new random order
                reviews.forEach(review => {
                    review.style.display = 'none';
                    review.classList.remove('fade-in');
                    reviewsList.appendChild(review);
                });
                
                const totalPages = Math.ceil(reviews.length / reviewsPerPage);
                
                // Set the total pages in pagination info
                const totalPagesElement = document.getElementById('totalPages');
                if (totalPagesElement) {
                    totalPagesElement.textContent = totalPages;
                }
                
                // Show first page of reviews
                reviews.forEach((item, index) => {
                    if (index < reviewsPerPage) {
                        item.style.display = 'block';
                        setTimeout(() => {
                            item.classList.add('fade-in');
                        }, index * 100);
                    }
                });
                
                // Handle pagination
                const prevButton = document.getElementById('prevReviews');
                const nextButton = document.getElementById('nextReviews');
                const currentPageElement = document.getElementById('currentPage');
                
                if (prevButton && nextButton && currentPageElement) {
                    let currentPage = 1;
                    
                    // Disable next button if only one page
                    if (totalPages <= 1) {
                        nextButton.disabled = true;
                    }
                    
                    nextButton.addEventListener('click', function() {
                        if (currentPage < totalPages) {
                            // Hide current page reviews
                            reviews.forEach((item, index) => {
                                const startIndex = (currentPage - 1) * reviewsPerPage;
                                const endIndex = startIndex + reviewsPerPage - 1;
                                
                                if (index >= startIndex && index <= endIndex) {
                                    item.classList.remove('fade-in');
                                    setTimeout(() => {
                                        item.style.display = 'none';
                                    }, 300);
                                }
                            });
                            
                            // Increment page and update UI
                            currentPage++;
                            currentPageElement.textContent = currentPage;
                            prevButton.disabled = false;
                            
                            // Show new page reviews
                            setTimeout(() => {
                                reviews.forEach((item, index) => {
                                    const startIndex = (currentPage - 1) * reviewsPerPage;
                                    const endIndex = startIndex + reviewsPerPage - 1;
                                    
                                    if (index >= startIndex && index <= endIndex) {
                                        item.style.display = 'block';
                                        setTimeout(() => {
                                            item.classList.add('fade-in');
                                        }, 50);
                                    }
                                });
                            }, 300);
                            
                            // Disable next button if last page
                            if (currentPage >= totalPages) {
                                nextButton.disabled = true;
                            }
                        }
                    });
                    
                    prevButton.addEventListener('click', function() {
                        if (currentPage > 1) {
                            // Hide current page reviews
                            reviews.forEach((item, index) => {
                                const startIndex = (currentPage - 1) * reviewsPerPage;
                                const endIndex = startIndex + reviewsPerPage - 1;
                                
                                if (index >= startIndex && index <= endIndex) {
                                    item.classList.remove('fade-in');
                                    setTimeout(() => {
                                        item.style.display = 'none';
                                    }, 300);
                                }
                            });
                            
                            // Decrement page and update UI
                            currentPage--;
                            currentPageElement.textContent = currentPage;
                            nextButton.disabled = false;
                            
                            // Show new page reviews
                            setTimeout(() => {
                                reviews.forEach((item, index) => {
                                    const startIndex = (currentPage - 1) * reviewsPerPage;
                                    const endIndex = startIndex + reviewsPerPage - 1;
                                    
                                    if (index >= startIndex && index <= endIndex) {
                                        item.style.display = 'block';
                                        setTimeout(() => {
                                            item.classList.add('fade-in');
                                        }, 50);
                                    }
                                });
                            }, 300);
                            
                            // Disable prev button if first page
                            if (currentPage <= 1) {
                                prevButton.disabled = true;
                            }
                        }
                    });
                }
            }
        }
        
        // Initialize everything
        function init() {
            // Add default styling for video thumbnails
            const style = document.createElement('style');
            style.textContent = `
                .video-thumbnail {
                    opacity: 0;
                    transition: opacity 0.3s ease;
                }
                .placeholder-icon {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    font-size: 36px;
                    color: rgba(255, 255, 255, 0.5);
                    z-index: 1;
                }
                .video-container {
                    background: linear-gradient(45deg, #333333, #222222);
                }
                .thumbnail[data-media-type="video"] {
                    background: linear-gradient(45deg, #333333, #222222);
                }
            `;
            document.head.appendChild(style);
            
            // Set up event handlers
            setupFAQHandlers();
            setupVideoClickHandlers();
            setupGalleryThumbnails();
            setupDateFormatting();
            setupReviewPagination();
            
            // Start preloading videos immediately
            preloadAllVideos();
        }
        
        // Start initialization
        init();
    });
</script>
{% endblock %}