{% extends 'MAIN/base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/store_item.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
{% endblock %}

{% block background %}
    {% include 'MAIN/base_background_starry.html' %}
{% endblock %}

{% block content %}
<div class="product-container">
    <!-- Back link -->
    <div class="product-navigation">
        <a href="{% url 'STORE:store' %}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Store
        </a>
    </div>
    
    <!-- Split layout for product -->
    <div class="product-split">
        <!-- Left side: Gallery -->
        <div class="product-gallery-side">
            <div class="product-featured-image">
                <img src="{% static 'images/1.jpg' %}" 
                     alt="Basic Package" class="featured-image" id="featuredImage">
            </div>
            
            <div class="gallery-thumbnails">
                <!-- Thumbnails -->
                <div class="thumbnail active" data-image="{% static 'images/1.jpg' %}">
                    <img src="{% static 'images/1.jpg' %}" alt="Main Package View">
                </div>
                <div class="thumbnail" data-image="{% static 'images/2.jpg' %}">
                    <img src="{% static 'images/2.jpg' %}" alt="Gallery Image 2">
                </div>
                <div class="thumbnail" data-image="{% static 'images/3.jpg' %}">
                    <img src="{% static 'images/3.jpg' %}" alt="Gallery Image 3">
                </div>
                <div class="thumbnail" data-image="{% static 'images/4.jpg' %}">
                    <img src="{% static 'images/4.jpg' %}" alt="Gallery Image 4">
                </div>
                <div class="thumbnail" data-image="{% static 'images/5.jpg' %}">
                    <img src="{% static 'images/5.jpg' %}" alt="Gallery Image 5">
                </div>
            </div>
        </div>
        
        <!-- Right side: Product info -->
        <div class="product-info-side">
            <div class="product-card">
                <h1 class="product-title">BASIC PACKAGE
                    <div class="product-status-container">
                        <div class="product-status {% if product.is_active %}active{% else %}inactive{% endif %}">
                            {% if product.is_active %}ACTIVE{% else %}INACTIVE{% endif %}
                        </div>
                        
                        {% if user.is_staff %}
                        <div class="admin-toggle" onclick="event.stopPropagation(); return false;">
                            <label class="toggle" data-product-id="{{ product.id }}" onclick="event.stopPropagation(); return false;">
                                <input type="checkbox" class="toggle-checkbox" {% if product.is_active %}checked{% endif %} onclick="event.stopPropagation();">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        {% endif %}
                    </div>
                </h1>
                <div class="product-description">
                    <h2>DESCRIPTION</h2>
                    <p>Start your streaming journey with our Basic Package. This includes a custom overlay with essential elements to make your stream look professional.</p>
                </div>
                
                <div class="product-features">
                    <h2>FEATURES:</h2>
                    <ul class="features-list">
                        <li>
                            <i class="fas fa-check-circle"></i>
                            Basic stream overlay
                        </li>
                        <li>
                            <i class="fas fa-check-circle"></i>
                            Simple alerts setup
                        </li>
                        <li>
                            <i class="fas fa-check-circle"></i>
                            Single scene design
                        </li>
                        <li>
                            <i class="fas fa-check-circle"></i>
                            1 minor revision
                        </li>
                    </ul>
                </div>
                
                <div class="product-purchase">
                    <div class="price-section">
                        <div class="price-label">Price:</div>
                        <div class="price-value">$25.00</div>
                    </div>
                    <a href="{% url 'contact' %}?subject=Purchase%20Basic%20Package" class="purchase-btn">PURCHASE NOW</a>
                </div>
            </div>
        </div>
    </div>

<script>
    // Simple CSRF token function
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Separate gallery functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Gallery image switching
        const featuredImage = document.getElementById('featuredImage');
        const thumbnails = document.querySelectorAll('.thumbnail');
        
        if (featuredImage && thumbnails.length > 0) {
            thumbnails.forEach(thumb => {
                thumb.addEventListener('click', function() {
                    featuredImage.src = this.getAttribute('data-image');
                    thumbnails.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }
        
        // Simple toggle function
        function toggleProduct(checkbox) {
            const productId = checkbox.closest('.toggle').dataset.productId;
            const statusElement = document.querySelector('.product-status');
            const isActive = checkbox.checked;
            
            // Update UI immediately
            statusElement.textContent = isActive ? 'ACTIVE' : 'INACTIVE';
            statusElement.className = 'product-status ' + (isActive ? 'active' : 'inactive');
            
            // API call
            fetch(`/STORE/admin/toggle/${productId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ active: isActive })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server error: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Product status updated:', data);
            })
            .catch(error => {
                console.error('Error updating product status:', error);
                // Revert UI on error
                checkbox.checked = !isActive;
                statusElement.textContent = !isActive ? 'ACTIVE' : 'INACTIVE';
                statusElement.className = 'product-status ' + (!isActive ? 'active' : 'inactive');
            });
        }

        // Add click handlers to admin toggles to stop propagation
        document.querySelectorAll('.admin-toggle').forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });

        // Add simple click handler to checkboxes
        document.querySelectorAll('.toggle-checkbox').forEach(checkbox => {
            checkbox.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            checkbox.addEventListener('change', function() {
                toggleProduct(this);
            });
        });
    });
</script>
{% endblock %}