{% extends 'MAIN/base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/store_item.css' %}">
    <link rel="stylesheet" href="{% static 'css/stream_asset.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
{% endblock %}

{% block background %}
    {% include 'MAIN/base_background_starry.html' %}
{% endblock %}

{% block content %}
<div class="product-container">
    <!-- Back link -->
    <div class="product-navigation">
        <a href="{% url 'STORE:stream_store' %}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Stream Store
        </a>
    </div>
    
    <!-- Split layout for product -->
    <div class="product-split">
        <!-- Left side: Gallery -->
        <div class="product-gallery-side">
            <div class="product-featured-image" id="featured-container">
                {% with thumbnail_media=False %}
                    {% for media in asset.media.all %}
                        {% if media.is_thumbnail and not thumbnail_media %}
                            {% if media.type == 'image' %}
                                {% if media.file %}
                                    <img src="{{ media.file.url }}" alt="{{ asset.name }}" class="featured-image" id="featuredImage">
                                {% elif media.file_path %}
                                    <img src="/media/{{ media.file_path }}" alt="{{ asset.name }}" class="featured-image" id="featuredImage">
                                {% endif %}
                            {% elif media.type == 'video' %}
                                <div class="video-container" id="videoContainer" data-src="{% if media.file %}{{ media.file.url }}{% elif media.file_path %}/media/{{ media.file_path }}{% endif %}">
                                    <video id="preloadVideo" style="display:none">
                                        <source src="{% if media.file %}{{ media.file.url }}{% elif media.file_path %}/media/{{ media.file_path }}{% endif %}" type="video/mp4">
                                    </video>
                                    <img src="" alt="{{ asset.name }}" class="video-thumbnail" id="videoThumbnail">
                                    <div class="play-overlay">
                                        <div class="play-button">
                                            <i class="fas fa-play"></i>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            {% with thumbnail_media=True %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if not thumbnail_media %}
                        {% with first_media=False %}
                            {% for media in asset.media.all %}
                                {% if forloop.first and not first_media %}
                                    {% if media.type == 'image' %}
                                        {% if media.file %}
                                            <img src="{{ media.file.url }}" alt="{{ asset.name }}" class="featured-image" id="featuredImage">
                                        {% elif media.file_path %}
                                            <img src="/media/{{ media.file_path }}" alt="{{ asset.name }}" class="featured-image" id="featuredImage">
                                        {% endif %}
                                    {% elif media.type == 'video' %}
                                        <div class="video-container" id="videoContainer" data-src="{% if media.file %}{{ media.file.url }}{% elif media.file_path %}/media/{{ media.file_path }}{% endif %}">
                                            <video id="preloadVideo" style="display:none">
                                                <source src="{% if media.file %}{{ media.file.url }}{% elif media.file_path %}/media/{{ media.file_path }}{% endif %}" type="video/mp4">
                                            </video>
                                            <img src="" alt="{{ asset.name }}" class="video-thumbnail" id="videoThumbnail">
                                            <div class="play-overlay">
                                                <div class="play-button">
                                                    <i class="fas fa-play"></i>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% with first_media=True %}{% endwith %}
                                {% endif %}
                            {% endfor %}
                        {% endwith %}
                    {% endif %}
                    
                    {% if asset.media.count == 0 %}
                        {% if asset.thumbnail %}
                            <img src="{{ asset.thumbnail.url }}" 
                                 alt="{{ asset.name }}" class="featured-image" id="featuredImage">
                        {% else %}
                            <div class="asset-placeholder">
                                <i class="fas fa-file-image"></i>
                                <span>{{ asset.name }}</span>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endwith %}
            </div>
            
            <div class="gallery-thumbnails">
                <!-- Thumbnails -->
                {% for media in asset.media.all %}
                    <div class="thumbnail {% if forloop.first %}active{% endif %}" 
                         data-media-type="{{ media.type }}" 
                         data-src="{% if media.file %}{{ media.file.url }}{% elif media.file_path %}/media/{{ media.file_path }}{% endif %}">
                        {% if media.file %}
                            <img src="{{ media.file.url }}" alt="{{ asset.name }} - Image {{ forloop.counter }}">
                        {% elif media.file_path %}
                            <img src="/media/{{ media.file_path }}" alt="{{ asset.name }} - Image {{ forloop.counter }}">
                        {% endif %}
                    </div>
                {% empty %}
                    {% if asset.thumbnail %}
                        <div class="thumbnail active" data-src="{{ asset.thumbnail.url }}" data-media-type="image">
                            <img src="{{ asset.thumbnail.url }}" alt="{{ asset.name }}">
                        </div>
                    {% else %}
                        <div class="thumbnail active" data-src="{% static 'images/placeholder.jpg' %}" data-media-type="image">
                            <img src="{% static 'images/placeholder.jpg' %}" alt="Placeholder">
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        
        <!-- Right side: Product info -->
        <div class="product-card">
            <h1 class="product-title">{{ asset.name }}
                <div class="product-status {% if asset.is_active %}active{% else %}inactive{% endif %}">
                    {% if asset.is_active %}ACTIVE{% else %}INACTIVE{% endif %}
                </div>
            </h1>
            <hr class="page-divider"></hr>
            
            {% if asset.versions.exists %}
            <div class="version-selector">
                <label for="versionSelect">Version:</label>
                <select id="versionSelect" class="version-select">
                    {% for version in asset.versions.all %}
                        <option value="{{ version.id }}" {% if forloop.first %}selected{% endif %}>
                            {{ version.get_type_display }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <div class="product-features-container">
                <div class="product-features">
                  <h2>FEATURES:</h2>
                  <ul class="features-list">
                    <li>
                      <i class="fas fa-check-circle"></i>
                        Overlay Files in ZIP format
                    </li>
                    <li>
                      <i class="fas fa-check-circle"></i>
                        Compatible with OBS
                    </li>
                    <li>
                      <i class="fas fa-check-circle"></i>
                        Personal Use License
                    </li>
                  </ul>
                </div>
                
                <div class="delivery-badge">
                    <i class="fa-solid fa-bolt"></i>
                  <span>Instant Access</span>
                </div>
            </div>
            
            <div class="product-purchase">
                <div class="price-section">
                    <div class="price-label">Price:</div>
                    <div class="price-value">${{ asset.price }}</div>
                    <div class="price-value-subtitle">
                        OR <span class="account-type client">CLIENT</span>
                    </div>
                </div>
                <a href="{% url 'STORE:download_asset' asset.id %}" class="purchase-btn" id="downloadBtn">
                    GET ACCESS
                </a>
            </div>
        </div>
    </div>
    
    <!-- Description section -->
    <div class="product-description-section">
        <div class="product-card">
            <div class="product-description">
                <h2 class="heading-with-line">DESCRIPTION</h2>
                <p>{{ asset.description|linebreaks }}</p>

                <h2 class="heading-with-line">FAQ</h2>
                <div class="faq-container">
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>How to install these overlays?</span>
                        </div>
                        <div class="faq-answer">
                            Download the ZIP file, extract contents to a folder on your computer. In OBS, add a new Browser source and point it to the extracted HTML file, or add the images as Image sources.
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>Can I customize these assets?</span>
                        </div>
                        <div class="faq-answer">
                            Yes! All assets come with editable files. You can modify colors, text, and other elements to match your brand.
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>What software do I need?</span>
                        </div>
                        <div class="faq-answer">
                            You'll need OBS Studio or similar streaming software. For customization, depending on the asset, you might need a graphics editor like GIMP (free) or Adobe Photoshop.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Global cache to store preloaded videos and thumbnails
        window.videoCache = {};
        
        // Preload and display the primary video immediately
        function loadFirstVideoImmediately() {
            const mainVideoContainer = document.getElementById('videoContainer');
            if (!mainVideoContainer) return;
            
            const videoSrc = mainVideoContainer.dataset.src;
            if (!videoSrc) return;
            
            // Create a video element for the main video
            const videoElement = document.createElement('video');
            videoElement.setAttribute('controls', true);
            videoElement.className = 'featured-image';
            videoElement.style.display = 'none'; // Hide initially
            videoElement.crossOrigin = "anonymous"; // Important for cloud storage
            
            // Set up source
            const sourceElement = document.createElement('source');
            sourceElement.src = videoSrc;
            sourceElement.type = 'video/mp4';
            videoElement.appendChild(sourceElement);
            
            // Ensure we show a proper loading state
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'video-loading';
            loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading video...';
            mainVideoContainer.appendChild(loadingIndicator);
            
            // When metadata is loaded, replace the thumbnail with actual video
            videoElement.addEventListener('loadedmetadata', function() {
                // Create a thumbnail first
                try {
                    videoElement.currentTime = 0.5; // Set to 0.5 seconds in
                    
                    videoElement.addEventListener('seeked', function onSeeked() {
                        // Create a new thumbnail for the video
                        const thumbnail = document.getElementById('videoThumbnail');
                        if (thumbnail) {
                            thumbnail.style.opacity = 1;
                            
                            // Show the container with the thumbnail
                            const playOverlay = mainVideoContainer.querySelector('.play-overlay');
                            if (playOverlay) {
                                playOverlay.style.display = 'flex';
                            }
                            
                            // Remove loading indicator
                            const loader = mainVideoContainer.querySelector('.video-loading');
                            if (loader) {
                                loader.remove();
                            }
                        }
                        
                        videoElement.removeEventListener('seeked', onSeeked);
                    }, { once: true });
                } catch (e) {
                    console.error("Error setting up video thumbnail:", e);
                    
                    // Remove loading indicator and show play button if thumbnail fails
                    const loader = mainVideoContainer.querySelector('.video-loading');
                    if (loader) {
                        loader.remove();
                    }
                    
                    const playOverlay = mainVideoContainer.querySelector('.play-overlay');
                    if (playOverlay) {
                        playOverlay.style.display = 'flex';
                    }
                }
            });
            
            // Handle errors more gracefully
            videoElement.addEventListener('error', function() {
                console.error("Error loading video:", videoElement.error);
                
                // Remove loading indicator
                const loader = mainVideoContainer.querySelector('.video-loading');
                if (loader) {
                    loader.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Video loading error. Click to try again.';
                    loader.className = 'video-error';
                }
                
                // Add retry functionality
                mainVideoContainer.addEventListener('click', function retryHandler() {
                    loadFirstVideoImmediately();
                    mainVideoContainer.removeEventListener('click', retryHandler);
                });
            });
            
            // Start loading
            videoElement.load();
            
            // Cache the video for later use
            window.videoCache[videoSrc] = {
                video: videoElement,
                loaded: false
            };
            
            // Set up click handler for playing
            mainVideoContainer.addEventListener('click', function() {
                // Remove any error messages
                const error = mainVideoContainer.querySelector('.video-error');
                if (error) {
                    error.remove();
                }
                
                // Create a fresh video element (avoids issues with reusing the cached one)
                const playVideoElement = document.createElement('video');
                playVideoElement.setAttribute('controls', true);
                playVideoElement.setAttribute('autoplay', true);
                playVideoElement.className = 'featured-image';
                playVideoElement.src = videoSrc;
                
                // Replace container with video
                mainVideoContainer.parentNode.replaceChild(playVideoElement, mainVideoContainer);
                playVideoElement.play().catch(e => {
                    console.error("Could not autoplay video:", e);
                    // If autoplay fails, show controls prominently
                    playVideoElement.controls = true;
                });
            });
        }
        
        // Handle thumbnail gallery functionality
        function setupGalleryThumbnails() {
            const thumbnails = document.querySelectorAll('.thumbnail');
            const featuredContainer = document.getElementById('featured-container');
            
            thumbnails.forEach(thumbnail => {
                thumbnail.addEventListener('click', function() {
                    // Update active state
                    thumbnails.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const mediaType = this.dataset.mediaType;
                    const mediaSrc = this.dataset.src;
                    
                    if (mediaType === 'video') {
                        // Create video container with loading indicator
                        const videoContainer = document.createElement('div');
                        videoContainer.className = 'video-container';
                        videoContainer.id = 'videoContainer';
                        videoContainer.dataset.src = mediaSrc;
                        
                        // Create loading indicator
                        const loadingIndicator = document.createElement('div');
                        loadingIndicator.className = 'video-loading';
                        loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading video...';
                        
                        // Create thumbnail image
                        const thumbnail = document.createElement('img');
                        thumbnail.className = 'video-thumbnail';
                        thumbnail.id = 'videoThumbnail';
                        thumbnail.alt = 'Video thumbnail';
                        thumbnail.style.opacity = 0; // Hide until loaded
                        
                        // Add play overlay (hidden initially)
                        const playOverlay = document.createElement('div');
                        playOverlay.className = 'play-overlay';
                        playOverlay.style.display = 'none'; // Hide until loaded
                        playOverlay.innerHTML = '<div class="play-button"><i class="fas fa-play"></i></div>';
                        
                        // Assemble container
                        videoContainer.appendChild(thumbnail);
                        videoContainer.appendChild(playOverlay);
                        videoContainer.appendChild(loadingIndicator);
                        
                        // Replace content in featured container
                        featuredContainer.innerHTML = '';
                        featuredContainer.appendChild(videoContainer);
                        
                        // Attempt to load the video and generate thumbnail
                        const videoElement = document.createElement('video');
                        videoElement.muted = true;
                        videoElement.crossOrigin = "anonymous"; // Important for cloud storage
                        videoElement.preload = 'metadata';
                        videoElement.src = mediaSrc;
                        
                        // When metadata is loaded, create thumbnail
                        videoElement.addEventListener('loadedmetadata', function() {
                            try {
                                videoElement.currentTime = 0.5; // Set to 0.5 seconds in
                                
                                videoElement.addEventListener('seeked', function onSeeked() {
                                    // Create canvas and generate thumbnail
                                    const canvas = document.createElement('canvas');
                                    canvas.width = videoElement.videoWidth * 0.5;
                                    canvas.height = videoElement.videoHeight * 0.5;
                                    
                                    try {
                                        const ctx = canvas.getContext('2d');
                                        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                                        
                                        // Apply thumbnail
                                        thumbnail.src = canvas.toDataURL('image/jpeg', 0.7);
                                        thumbnail.style.opacity = 1;
                                        
                                        // Show play overlay
                                        playOverlay.style.display = 'flex';
                                        
                                        // Remove loading indicator
                                        loadingIndicator.remove();
                                    } catch(e) {
                                        console.error("Could not generate thumbnail", e);
                                        playOverlay.style.display = 'flex';
                                        loadingIndicator.remove();
                                    }
                                    
                                    videoElement.removeEventListener('seeked', onSeeked);
                                }, { once: true });
                            } catch(e) {
                                console.error("Error setting video time for thumbnail", e);
                                playOverlay.style.display = 'flex';
                                loadingIndicator.remove();
                            }
                        });
                        
                        // Handle loading errors
                        videoElement.addEventListener('error', function() {
                            console.error("Error loading video:", videoElement.error);
                            loadingIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Video loading error';
                            loadingIndicator.className = 'video-error';
                        });
                        
                        // Start loading
                        videoElement.load();
                        
                        // Set up click handler for playing the video
                        videoContainer.addEventListener('click', function() {
                            const playVideoElement = document.createElement('video');
                            playVideoElement.setAttribute('controls', true);
                            playVideoElement.setAttribute('autoplay', true);
                            playVideoElement.className = 'featured-image';
                            playVideoElement.src = mediaSrc;
                            
                            // Replace container with video
                            featuredContainer.innerHTML = '';
                            featuredContainer.appendChild(playVideoElement);
                            playVideoElement.play().catch(e => {
                                console.error("Could not autoplay video:", e);
                                playVideoElement.controls = true;
                            });
                        });
                    } else {
                        // Handle image content
                        const imageElement = document.createElement('img');
                        imageElement.src = mediaSrc;
                        imageElement.alt = 'Featured image';
                        imageElement.className = 'featured-image';
                        imageElement.id = 'featuredImage';
                        
                        featuredContainer.innerHTML = '';
                        featuredContainer.appendChild(imageElement);
                    }
                });
            });
        }
        
        // Version selector functionality
        function setupVersionSelector() {
            const versionSelect = document.getElementById('versionSelect');
            const downloadBtn = document.getElementById('downloadBtn');
            
            if (versionSelect && downloadBtn) {
                // Set initial version in download URL
                if (versionSelect.options.length > 0) {
                    const initialVersion = versionSelect.options[0].value;
                    const baseUrl = downloadBtn.href.split('?')[0];
                    downloadBtn.href = baseUrl + '?version_id=' + initialVersion;
                }
                
                versionSelect.addEventListener('change', function() {
                    // Update download button link to include selected version
                    const versionId = this.value;
                    const baseUrl = downloadBtn.href.split('?')[0];
                    downloadBtn.href = baseUrl + '?version_id=' + versionId;
                });
            }
        }
        
        // FAQ functionality
        function setupFAQHandlers() {
            const faqItems = document.querySelectorAll('.faq-item');
            
            faqItems.forEach(item => {
                const question = item.querySelector('.faq-question');
                
                question.addEventListener('click', function() {
                    // Toggle active class
                    item.classList.toggle('active');
                    
                    // Get the chevron container
                    const chevronContainer = this.querySelector('.chevron-container');
                    
                    // Toggle chevron direction
                    if(item.classList.contains('active')) {
                        chevronContainer.innerHTML = '<i class="fas fa-chevron-down"></i>';
                    } else {
                        chevronContainer.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    }
                });
            });
        }
        
        // Add CSS for loading states
        function addLoadingStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .video-loading {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: rgba(0,0,0,0.7);
                    color: white;
                    font-size: 16px;
                }
                
                .video-loading i {
                    margin-right: 8px;
                }
                
                .video-error {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    font-size: 14px;
                    text-align: center;
                    cursor: pointer;
                }
                
                .video-error i {
                    font-size: 24px;
                    margin-bottom: 8px;
                    color: #ff4d4d;
                }
            `;
            document.head.appendChild(style);
        }
        
        // Initialize everything
        function init() {
            // Add loading indicator styles
            addLoadingStyles();
            
            // Set up event handlers
            setupFAQHandlers();
            setupGalleryThumbnails();
            setupVersionSelector();
            
            // Start loading first video immediately
            setTimeout(loadFirstVideoImmediately, 100);
        }
        
        // Start initialization
        init();
    });
</script>
{% endblock %}