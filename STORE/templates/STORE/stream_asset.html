{% extends 'MAIN/base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/store_item.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        .version-selector {
            margin-bottom: 15px;
            padding: 10px;
            background-color: rgba(25, 25, 25, 0.5);
            border-radius: 5px;
        }
        
        .version-select {
            padding: 8px;
            width: 100%;
            margin-top: 5px;
            border-radius: 3px;
            border: 1px solid #444;
            background-color: #222;
            color: white;
        }
        
        /* Video thumbnail styling */
        .thumbnail[data-media-type="video"] {
            position: relative;
        }
        
        .thumbnail[data-media-type="video"]::before {
            content: '\f144';
            font-family: 'Font Awesome 6 Free';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            color: white;
            z-index: 10;
            opacity: 0.8;
        }
    </style>
{% endblock %}

{% block background %}
    {% include 'MAIN/base_background_starry.html' %}
{% endblock %}

{% block content %}
<div class="product-container">
    <!-- Back link -->
    <div class="product-navigation">
        <a href="{% url 'STORE:stream_store' %}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Stream Store
        </a>
    </div>
    
    <!-- Split layout for product -->
    <div class="product-split">
        <!-- Left side: Gallery -->
        <div class="product-gallery-side">
            <div class="product-featured-image">
                {% for media in asset.media.all %}
                    {% if media.is_thumbnail or forloop.first %}
                        {% if media.type == 'image' %}
                            <img src="{{ media.file.url }}" 
                                 alt="{{ asset.name }}" class="featured-image" id="featuredImage">
                        {% elif media.type == 'video' %}
                            <video src="{{ media.file.url }}" controls class="featured-image" id="featuredVideo"></video>
                            <img src="{{ media.file.url }}" 
                                 alt="{{ asset.name }}" class="featured-image" id="featuredImage" style="display: none;">
                        {% endif %}
                        {% comment %}We only want to display the first matching media{% endcomment %}
                        
                    {% endif %}
                {% empty %}
                    {% if asset.thumbnail %}
                        <img src="{{ asset.thumbnail.url }}" 
                             alt="{{ asset.name }}" class="featured-image" id="featuredImage">
                    {% else %}
                        <img src="{% static 'images/placeholder.jpg' %}" 
                             alt="{{ asset.name }}" class="featured-image" id="featuredImage">
                    {% endif %}
                {% endfor %}
            </div>
            
            <div class="gallery-thumbnails">
                <!-- Thumbnails -->
                {% for media in asset.media.all %}
                    <div class="thumbnail {% if forloop.first %}active{% endif %}" 
                         data-media-type="{{ media.type }}" 
                         data-image="{{ media.file.url }}">
                        <img src="{{ media.file.url }}" alt="{{ asset.name }} - Image {{ forloop.counter }}">
                    </div>
                {% empty %}
                    {% if asset.thumbnail %}
                        <div class="thumbnail active" data-image="{{ asset.thumbnail.url }}">
                            <img src="{{ asset.thumbnail.url }}" alt="{{ asset.name }}">
                        </div>
                    {% else %}
                        <div class="thumbnail active" data-image="{% static 'images/placeholder.jpg' %}">
                            <img src="{% static 'images/placeholder.jpg' %}" alt="Placeholder">
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        
        <!-- Right side: Product info -->
        <div class="product-card">
            <h1 class="product-title">{{ asset.name }}
                <div class="product-status {% if asset.is_active %}active{% else %}inactive{% endif %}">
                    {% if asset.is_active %}ACTIVE{% else %}INACTIVE{% endif %}
                </div>
            </h1>
            <hr class="page-divider"></hr>
            
            {% if asset.versions.exists %}
            <div class="version-selector">
                <label for="versionSelect">Version:</label>
                <select id="versionSelect" class="version-select">
                    {% for version in asset.versions.all %}
                        <option value="{{ version.id }}" {% if forloop.first %}selected{% endif %}>{{ version.name }} ({{ version.get_type_display }})</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <div class="product-features-container">
                <div class="product-features">
                  <h2>FEATURES:</h2>
                  <ul class="features-list">
                    <li>
                      <i class="fas fa-check-circle"></i>
                        Overlay Files in ZIP format
                    </li>
                    <li>
                      <i class="fas fa-check-circle"></i>
                        Compatible with OBS
                    </li>
                    <li>
                      <i class="fas fa-check-circle"></i>
                        Personal Use License
                    </li>
                  </ul>
                </div>
                
                <div class="delivery-badge">
                    <i class="fa-solid fa-bolt"></i>
                  <span>Instant Access</span>
                </div>
            </div>
            
            <div class="product-purchase">
                <div class="price-section">
                    <div class="price-label">Price:</div>
                    <div class="price-value">${{ asset.price }}</div>
                    <div class="price-value-subtitle">
                        OR <span class="account-type client">CLIENT</span>
                    </div>
                </div>
                <a href="{% url 'STORE:download_asset' asset.id %}" class="purchase-btn" id="downloadBtn">
                    GET ACCESS
                </a>
            </div>
        </div>
    </div>
    
    <!-- Description section -->
    <div class="product-description-section">
        <div class="product-card">
            <div class="product-description">
                <h2 class="heading-with-line">DESCRIPTION</h2>
                <p>{{ asset.description|linebreaks }}</p>

                <h2 class="heading-with-line">USAGE INSTRUCTIONS</h2>
                <div class="faq-container">
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>How to install these overlays?</span>
                        </div>
                        <div class="faq-answer">
                            Download the ZIP file, extract contents to a folder on your computer. In OBS, add a new Browser source and point it to the extracted HTML file, or add the images as Image sources.
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>Can I customize these assets?</span>
                        </div>
                        <div class="faq-answer">
                            Yes! All assets come with editable files. You can modify colors, text, and other elements to match your brand.
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>What software do I need?</span>
                        </div>
                        <div class="faq-answer">
                            You'll need OBS Studio or similar streaming software. For customization, depending on the asset, you might need a graphics editor like GIMP (free) or Adobe Photoshop.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // FAQ dropdown functionality
        const faqItems = document.querySelectorAll('.faq-item');
        
        faqItems.forEach(item => {
            const question = item.querySelector('.faq-question');
            
            question.addEventListener('click', function() {
                // Toggle active class
                item.classList.toggle('active');
                
                // Get the chevron container
                const chevronContainer = this.querySelector('.chevron-container');
                
                // Toggle chevron direction
                if(item.classList.contains('active')) {
                    chevronContainer.innerHTML = '<i class="fas fa-chevron-down"></i>';
                } else {
                    chevronContainer.innerHTML = '<i class="fas fa-chevron-right"></i>';
                }
            });
        });
        
        // Gallery functionality
        const thumbnails = document.querySelectorAll('.thumbnail');
        const featuredImage = document.getElementById('featuredImage');
        const featuredVideo = document.getElementById('featuredVideo');
        
        thumbnails.forEach(thumbnail => {
            thumbnail.addEventListener('click', function() {
                // Set all thumbnails as inactive
                thumbnails.forEach(t => t.classList.remove('active'));
                
                // Set this thumbnail as active
                this.classList.add('active');
                
                // Update featured media based on type
                const mediaType = this.dataset.mediaType;
                const mediaSrc = this.dataset.image;
                
                if (mediaType === 'video') {
                    // Create new video element if it doesn't exist
                    let featuredVideo = document.getElementById('featuredVideo');
                    if (!featuredVideo) {
                        featuredVideo = document.createElement('video');
                        featuredVideo.id = 'featuredVideo';
                        featuredVideo.className = 'featured-image';
                        featuredVideo.controls = true;
                        document.querySelector('.product-featured-image').appendChild(featuredVideo);
                    }
                    
                    // Show video, hide image
                    featuredVideo.src = mediaSrc;
                    featuredVideo.style.display = 'block';
                    featuredImage.style.display = 'none';
                    featuredVideo.load(); // Reload the video
                    featuredVideo.play(); // Autoplay the video
                } else {
                    // Show image, hide video
                    const featuredVideo = document.getElementById('featuredVideo');
                    if (featuredVideo) featuredVideo.style.display = 'none';
                    featuredImage.style.display = 'block';
                    featuredImage.src = mediaSrc;
                }
            });
        });
        
        // Version selector functionality
        const versionSelect = document.getElementById('versionSelect');
        const downloadBtn = document.getElementById('downloadBtn');
        
        if (versionSelect && downloadBtn) {
            // Set initial version in download URL
            if (versionSelect.options.length > 0) {
                const initialVersion = versionSelect.options[0].value;
                const baseUrl = downloadBtn.href.split('?')[0];
                downloadBtn.href = baseUrl + '?version_id=' + initialVersion;
            }
            
            versionSelect.addEventListener('change', function() {
                // Update download button link to include selected version
                const versionId = this.value;
                const baseUrl = downloadBtn.href.split('?')[0];
                downloadBtn.href = baseUrl + '?version_id=' + versionId;
            });
        }
    });
</script>
{% endblock %}