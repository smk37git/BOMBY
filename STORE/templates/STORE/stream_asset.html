{% extends 'MAIN/base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/store_item.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        .version-select {
            padding: 10px 15px;
            width: 100%;
            margin-top: 5px;
            border-radius: 8px;
            border: 2px solid #444;
            background-color: #222;
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 15px top 50%;
            background-size: 12px auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .version-select:hover {
            border-color: #a970ff;
            box-shadow: 0 4px 12px rgba(169, 112, 255, 0.3);
        }

        .version-select:focus {
            outline: none;
            border-color: #a970ff;
            box-shadow: 0 0 0 3px rgba(169, 112, 255, 0.3);
        }

        .version-selector {
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(25, 25, 25, 0.6);
            border-radius: 10px;
            border: 1px solid #333;
        }

        .version-selector label {
            font-weight: bold;
            color: #a970ff;
            display: block;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        /* Video styling */
        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            overflow: hidden;
            cursor: pointer;
        }
        
        .video-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.4);
            transition: background-color 0.3s ease;
        }
        
        .play-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.8);
            color: white;
            font-size: 24px;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        
        .video-container:hover .play-overlay {
            background-color: rgba(0, 0, 0, 0.3);
        }
        
        .video-container:hover .play-button {
            transform: scale(1.1);
            background-color: rgb(255, 255, 255);
        }
        
        /* Video thumbnails in gallery */
        .gallery-thumbnails .thumbnail[data-media-type="video"] {
            position: relative;
        }
        
        .gallery-thumbnails .thumbnail[data-media-type="video"]::after {
            content: '\f144';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            color: #ffffff;
            z-index: 2;
        }
        
        .gallery-thumbnails .thumbnail[data-media-type="video"]::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 1;
        }
        
        /* Gallery improvements */
        .thumbnail.active {
            border-color: #ffffff !important;
            box-shadow: 0 0 15px rgba(169, 112, 255, 0.5) !important;
        }
        
        /* Asset placeholder */
        .asset-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #1a1a1a;
            color: white;
            font-size: 1.2rem;
            padding: 20px;
            text-align: center;
        }
        
        .asset-placeholder i {
            font-size: 3rem;
            margin-bottom: 10px;
            color: #a970ff;
        }
    </style>
{% endblock %}

{% block background %}
    {% include 'MAIN/base_background_starry.html' %}
{% endblock %}

{% block content %}
<div class="product-container">
    <!-- Back link -->
    <div class="product-navigation">
        <a href="{% url 'STORE:stream_store' %}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Stream Store
        </a>
    </div>
    
    <!-- Split layout for product -->
    <div class="product-split">
        <!-- Left side: Gallery -->
        <div class="product-gallery-side">
            <div class="product-featured-image" id="featured-container">
                {% with thumbnail_media=False %}
                    {% for media in asset.media.all %}
                        {% if media.is_thumbnail and not thumbnail_media %}
                            {% if media.type == 'image' %}
                                <img src="{{ media.file.url }}" 
                                     alt="{{ asset.name }}" class="featured-image" id="featuredImage">
                            {% elif media.type == 'video' %}
                                <div class="video-container" id="videoContainer" data-src="{{ media.file.url }}">
                                    <video id="preloadVideo" style="display:none">
                                        <source src="{{ media.file.url }}" type="video/mp4">
                                    </video>
                                    <img src="" alt="{{ asset.name }}" class="video-thumbnail" id="videoThumbnail">
                                    <div class="play-overlay">
                                        <div class="play-button">
                                            <i class="fas fa-play"></i>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            {% with thumbnail_media=True %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if not thumbnail_media %}
                        {% with first_media=False %}
                            {% for media in asset.media.all %}
                                {% if forloop.first and not first_media %}
                                    {% if media.type == 'image' %}
                                        <img src="{{ media.file.url }}" 
                                             alt="{{ asset.name }}" class="featured-image" id="featuredImage">
                                    {% elif media.type == 'video' %}
                                        <div class="video-container" id="videoContainer" data-src="{{ media.file.url }}">
                                            <video id="preloadVideo" style="display:none">
                                                <source src="{{ media.file.url }}" type="video/mp4">
                                            </video>
                                            <img src="" alt="{{ asset.name }}" class="video-thumbnail" id="videoThumbnail">
                                            <div class="play-overlay">
                                                <div class="play-button">
                                                    <i class="fas fa-play"></i>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% with first_media=True %}{% endwith %}
                                {% endif %}
                            {% endfor %}
                        {% endwith %}
                    {% endif %}
                    
                    {% if asset.media.count == 0 %}
                        {% if asset.thumbnail %}
                            <img src="{{ asset.thumbnail.url }}" 
                                 alt="{{ asset.name }}" class="featured-image" id="featuredImage">
                        {% else %}
                            <div class="asset-placeholder">
                                <i class="fas fa-file-image"></i>
                                <span>{{ asset.name }}</span>
                            </div>
                        {% endif %}
                    {% endif %}
                {% endwith %}
            </div>
            
            <div class="gallery-thumbnails">
                <!-- Thumbnails -->
                {% for media in asset.media.all %}
                    <div class="thumbnail {% if forloop.first %}active{% endif %}" 
                         data-media-type="{{ media.type }}" 
                         data-src="{{ media.file.url }}">
                        <img src="{{ media.file.url }}" alt="{{ asset.name }} - Image {{ forloop.counter }}">
                    </div>
                {% empty %}
                    {% if asset.thumbnail %}
                        <div class="thumbnail active" data-src="{{ asset.thumbnail.url }}" data-media-type="image">
                            <img src="{{ asset.thumbnail.url }}" alt="{{ asset.name }}">
                        </div>
                    {% else %}
                        <div class="thumbnail active" data-src="{% static 'images/placeholder.jpg' %}" data-media-type="image">
                            <img src="{% static 'images/placeholder.jpg' %}" alt="Placeholder">
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        
        <!-- Right side: Product info -->
        <div class="product-card">
            <h1 class="product-title">{{ asset.name }}
                <div class="product-status {% if asset.is_active %}active{% else %}inactive{% endif %}">
                    {% if asset.is_active %}ACTIVE{% else %}INACTIVE{% endif %}
                </div>
            </h1>
            <hr class="page-divider"></hr>
            
            {% if asset.versions.exists %}
            <div class="version-selector">
                <label for="versionSelect">Version:</label>
                <select id="versionSelect" class="version-select">
                    {% for version in asset.versions.all %}
                        <option value="{{ version.id }}" {% if forloop.first %}selected{% endif %}>
                            {{ version.get_type_display }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <div class="product-features-container">
                <div class="product-features">
                  <h2>FEATURES:</h2>
                  <ul class="features-list">
                    <li>
                      <i class="fas fa-check-circle"></i>
                        Overlay Files in ZIP format
                    </li>
                    <li>
                      <i class="fas fa-check-circle"></i>
                        Compatible with OBS
                    </li>
                    <li>
                      <i class="fas fa-check-circle"></i>
                        Personal Use License
                    </li>
                  </ul>
                </div>
                
                <div class="delivery-badge">
                    <i class="fa-solid fa-bolt"></i>
                  <span>Instant Access</span>
                </div>
            </div>
            
            <div class="product-purchase">
                <div class="price-section">
                    <div class="price-label">Price:</div>
                    <div class="price-value">${{ asset.price }}</div>
                    <div class="price-value-subtitle">
                        OR <span class="account-type client">CLIENT</span>
                    </div>
                </div>
                <a href="{% url 'STORE:download_asset' asset.id %}" class="purchase-btn" id="downloadBtn">
                    GET ACCESS
                </a>
            </div>
        </div>
    </div>
    
    <!-- Description section -->
    <div class="product-description-section">
        <div class="product-card">
            <div class="product-description">
                <h2 class="heading-with-line">DESCRIPTION</h2>
                <p>{{ asset.description|linebreaks }}</p>

                <h2 class="heading-with-line">USAGE INSTRUCTIONS</h2>
                <div class="faq-container">
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>How to install these overlays?</span>
                        </div>
                        <div class="faq-answer">
                            Download the ZIP file, extract contents to a folder on your computer. In OBS, add a new Browser source and point it to the extracted HTML file, or add the images as Image sources.
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>Can I customize these assets?</span>
                        </div>
                        <div class="faq-answer">
                            Yes! All assets come with editable files. You can modify colors, text, and other elements to match your brand.
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">
                            <div class="chevron-container">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                            <span>What software do I need?</span>
                        </div>
                        <div class="faq-answer">
                            You'll need OBS Studio or similar streaming software. For customization, depending on the asset, you might need a graphics editor like GIMP (free) or Adobe Photoshop.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Global cache to store preloaded videos and thumbnails
        window.videoCache = {};
        
        // Immediately preload all videos
        function preloadAllVideos() {
            // First, identify all video sources
            const videoSources = [];
            
            // Get main featured video if any
            const mainVideoContainer = document.getElementById('videoContainer');
            if (mainVideoContainer) {
                videoSources.push(mainVideoContainer.dataset.src);
            }
            
            // Get all thumbnail videos
            document.querySelectorAll('.thumbnail[data-media-type="video"]').forEach(thumb => {
                videoSources.push(thumb.dataset.src);
            });
            
            // Now preload all videos and generate thumbnails
            videoSources.forEach((src, index) => {
                if (!src || window.videoCache[src]) return; // Skip if already cached
                
                const video = document.createElement('video');
                video.muted = true;
                video.preload = 'auto';
                video.crossOrigin = 'anonymous';
                video.style.display = 'none';
                
                // Add to cache first to prevent duplicate processing
                window.videoCache[src] = {
                    video: video,
                    loaded: false,
                    thumbnail: null
                };
                
                // Set video attributes
                const sourceElement = document.createElement('source');
                sourceElement.src = src;
                sourceElement.type = 'video/mp4';
                video.appendChild(sourceElement);
                document.body.appendChild(video);
                
                // Generate thumbnail on metadata load (faster than waiting for full load)
                video.addEventListener('loadeddata', function onDataLoaded() {
                    // Generate thumbnail immediately
                    video.currentTime = 0.1;
                    
                    video.addEventListener('seeked', function onSeeked() {
                        // Create canvas and generate thumbnail
                        const canvas = document.createElement('canvas');
                        // Use small size for efficiency
                        const scale = 0.5;
                        canvas.width = video.videoWidth * scale;
                        canvas.height = video.videoHeight * scale;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        try {
                            // Save thumbnail to cache
                            const dataURL = canvas.toDataURL('image/jpeg', 0.7);
                            window.videoCache[src].thumbnail = dataURL;
                            window.videoCache[src].loaded = true;
                            
                            // Apply thumbnail to all matching elements immediately
                            applyThumbnailToMatchingElements(src, dataURL);
                            
                            // Remove event listener to prevent multiple executions
                            video.removeEventListener('seeked', onSeeked);
                        } catch(e) {
                            console.error("Could not generate thumbnail", e);
                        }
                    });
                    
                    // Remove event listener
                    video.removeEventListener('loadeddata', onDataLoaded);
                });
                
                // Start loading
                video.load();
            });
        }
        
        // Apply thumbnails to all matching elements
        function applyThumbnailToMatchingElements(videoSrc, thumbnailSrc) {
            // Apply to main video container
            const mainContainer = document.getElementById('videoContainer');
            if (mainContainer && mainContainer.dataset.src === videoSrc) {
                const mainThumb = document.getElementById('videoThumbnail');
                if (mainThumb) {
                    mainThumb.src = thumbnailSrc;
                    mainThumb.style.opacity = 1;
                }
            }
            
            // Apply to all matching gallery thumbnails
            document.querySelectorAll(`.thumbnail[data-media-type="video"][data-src="${videoSrc}"] img`).forEach(img => {
                img.src = thumbnailSrc;
                img.style.opacity = 1;
            });
        }
        
        // Handle click on the video to play immediately
        function setupVideoClickHandlers() {
            // Main video container
            const videoContainer = document.getElementById('videoContainer');
            if (videoContainer) {
                videoContainer.addEventListener('click', function() {
                    const videoSrc = this.dataset.src;
                    
                    // If we've preloaded the video, use it
                    if (window.videoCache[videoSrc] && window.videoCache[videoSrc].video) {
                        const videoElement = document.createElement('video');
                        videoElement.setAttribute('controls', true);
                        videoElement.setAttribute('autoplay', true);
                        videoElement.className = 'featured-image';
                        videoElement.src = videoSrc;
                        
                        // Replace container with video
                        this.parentNode.replaceChild(videoElement, this);
                        videoElement.play();
                    }
                });
            }
        }
        
        // Handle thumbnail gallery functionality
        function setupGalleryThumbnails() {
            const thumbnails = document.querySelectorAll('.thumbnail');
            const featuredContainer = document.getElementById('featured-container');
            
            thumbnails.forEach(thumbnail => {
                thumbnail.addEventListener('click', function() {
                    // Update active state
                    thumbnails.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const mediaType = this.dataset.mediaType;
                    const mediaSrc = this.dataset.src;
                    
                    if (mediaType === 'video') {
                        // Create video container with preloaded thumbnail
                        const videoContainer = document.createElement('div');
                        videoContainer.className = 'video-container';
                        videoContainer.id = 'videoContainer';
                        videoContainer.dataset.src = mediaSrc;
                        
                        // Create thumbnail image
                        const thumbnail = document.createElement('img');
                        thumbnail.className = 'video-thumbnail';
                        thumbnail.id = 'videoThumbnail';
                        thumbnail.alt = 'Video thumbnail';
                        
                        // Use cached thumbnail if available
                        if (window.videoCache[mediaSrc] && window.videoCache[mediaSrc].thumbnail) {
                            thumbnail.src = window.videoCache[mediaSrc].thumbnail;
                            thumbnail.style.opacity = 1;
                        }
                        
                        // Add play overlay
                        const playOverlay = document.createElement('div');
                        playOverlay.className = 'play-overlay';
                        playOverlay.innerHTML = '<div class="play-button"><i class="fas fa-play"></i></div>';
                        
                        // Assemble container
                        videoContainer.appendChild(thumbnail);
                        videoContainer.appendChild(playOverlay);
                        
                        // Replace content in featured container
                        featuredContainer.innerHTML = '';
                        featuredContainer.appendChild(videoContainer);
                        
                        // Set up click handler for playing the video
                        videoContainer.addEventListener('click', function() {
                            const videoElement = document.createElement('video');
                            videoElement.setAttribute('controls', true);
                            videoElement.setAttribute('autoplay', true);
                            videoElement.className = 'featured-image';
                            videoElement.src = this.dataset.src;
                            
                            // Replace container with video
                            featuredContainer.innerHTML = '';
                            featuredContainer.appendChild(videoElement);
                            videoElement.play();
                        });
                    } else {
                        // Handle image content
                        const imageElement = document.createElement('img');
                        imageElement.src = mediaSrc;
                        imageElement.alt = 'Featured image';
                        imageElement.className = 'featured-image';
                        imageElement.id = 'featuredImage';
                        
                        featuredContainer.innerHTML = '';
                        featuredContainer.appendChild(imageElement);
                    }
                });
            });
        }
        
        // Version selector functionality
        function setupVersionSelector() {
            const versionSelect = document.getElementById('versionSelect');
            const downloadBtn = document.getElementById('downloadBtn');
            
            if (versionSelect && downloadBtn) {
                // Set initial version in download URL
                if (versionSelect.options.length > 0) {
                    const initialVersion = versionSelect.options[0].value;
                    const baseUrl = downloadBtn.href.split('?')[0];
                    downloadBtn.href = baseUrl + '?version_id=' + initialVersion;
                }
                
                versionSelect.addEventListener('change', function() {
                    // Update download button link to include selected version
                    const versionId = this.value;
                    const baseUrl = downloadBtn.href.split('?')[0];
                    downloadBtn.href = baseUrl + '?version_id=' + versionId;
                });
            }
        }
        
        // FAQ functionality
        function setupFAQHandlers() {
            const faqItems = document.querySelectorAll('.faq-item');
            
            faqItems.forEach(item => {
                const question = item.querySelector('.faq-question');
                
                question.addEventListener('click', function() {
                    // Toggle active class
                    item.classList.toggle('active');
                    
                    // Get the chevron container
                    const chevronContainer = this.querySelector('.chevron-container');
                    
                    // Toggle chevron direction
                    if(item.classList.contains('active')) {
                        chevronContainer.innerHTML = '<i class="fas fa-chevron-down"></i>';
                    } else {
                        chevronContainer.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    }
                });
            });
        }
        
        // Initialize everything
        function init() {
            // Set up event handlers
            setupFAQHandlers();
            setupVideoClickHandlers();
            setupGalleryThumbnails();
            setupVersionSelector();
            
            // Start preloading videos immediately
            preloadAllVideos();
        }
        
        // Start initialization
        init();
    });
</script>
{% endblock %}