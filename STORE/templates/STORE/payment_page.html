{% extends 'MAIN/base.html' %}
{% load static %}

{% block title %}Checkout - {{ product.name }} | BOMBY{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/payment.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
{% endblock %}

{% block background %}
{% include 'MAIN/base_background_starry.html' %}
{% endblock %}

{% block content %}
<div class="checkout-container">
    <div class="checkout-top-row">
        <a href="{{ product_url }}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Store
        </a>
        <div class="checkout-header">
            <h1>Secure Checkout</h1>
        </div>
        <div class="checkout-spacer"></div>
    </div>
    
    <div class="checkout-grid">
        <div class="order-summary-card">
            <h2><i class="fas fa-shopping-cart" style="margin-right: 10px; color: #a855f7;"></i>Order Summary</h2>
            
            <div class="checkout-product-item">
                <div class="checkout-product-icon">
                    <i class="fas fa-box"></i>
                </div>
                <div class="checkout-product-details">
                    <h3>{{ product.name }}</h3>
                    <p>Digital Service</p>
                </div>
                <div class="checkout-product-price">${{ product.price }}</div>
            </div>
            
            <div class="discount-section" id="discount-section">
                {% if discount_applied %}
                <div class="discount-success">
                    <i class="fas fa-check-circle"></i>
                    <span>Code "{{ discount_code }}" applied!</span>
                </div>
                {% else %}
                <h3>Have a discount code?</h3>
                <form id="discount-form" class="discount-form">
                    <input type="text" id="discount-input" name="discount_code" class="discount-input" placeholder="Enter code" required>
                    <button type="submit" class="apply-btn" id="apply-btn">Apply</button>
                </form>
                <p class="discount-error" id="discount-error" style="display: none;"></p>
                {% if discount_error %}
                <p class="discount-error">{{ discount_error }}</p>
                {% endif %}
                {% endif %}
            </div>
            
            <div class="order-totals" id="order-totals">
                {% if discount_applied and discount_amount > 0 %}
                <div class="total-row subtotal">
                    <span>Subtotal</span>
                    <span>${{ product.price }}</span>
                </div>
                <div class="total-row discount-row">
                    <span>Discount</span>
                    <span>-${{ discount_amount|floatformat:2 }}</span>
                </div>
                <div class="total-row final">
                    <span class="label">Total</span>
                    <span class="value">${{ final_price|floatformat:2 }}</span>
                </div>
                {% else %}
                <div class="total-row final">
                    <span class="label">Total</span>
                    <span class="value">${{ product.price }}</span>
                </div>
                {% endif %}
            </div>
            
            <div class="secure-badge">
                <i class="fas fa-lock"></i>
                <span>Secured by Stripe â€¢ 256-bit SSL encryption</span>
            </div>
        </div>
        
        <div class="checkout-card">
            <h2><i class="fas fa-credit-card" style="margin-right: 10px; color: #a855f7;"></i>Payment Details</h2>
            
            <div id="checkout-loading" class="checkout-loading">
                <div class="spinner"></div>
                <p>Loading secure checkout...</p>
            </div>
            
            <div id="checkout"></div>
            
            <div id="checkout-error" class="checkout-error" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Error loading checkout. Please refresh and try again.</p>
            </div>
            
            <div class="payment-methods">
                <span>We accept:</span>
                <i class="fab fa-cc-visa"></i>
                <i class="fab fa-cc-mastercard"></i>
                <i class="fab fa-cc-amex"></i>
                <i class="fab fa-cc-discover"></i>
                <i class="fab fa-cc-apple-pay"></i>
                <i class="fab fa-google-pay"></i>
            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
(function() {
    var STRIPE_KEY = "{{ stripe_publishable_key }}";
    var CSRF_TOKEN = "{{ csrf_token }}";
    var PRODUCT_ID = "{{ product.id }}";
    var ORIGINAL_PRICE = "{{ product.price }}";
    
    function showError(msg) {
        document.getElementById('checkout-loading').style.display = 'none';
        var el = document.getElementById('checkout-error');
        el.style.display = 'block';
        el.innerHTML = '<i class="fas fa-exclamation-triangle"></i><p>' + msg + '</p>';
    }
    
    if (!STRIPE_KEY || STRIPE_KEY === '' || STRIPE_KEY === 'None') {
        showError('Payment system temporarily unavailable. Please try again later.');
        console.error('Stripe key missing:', STRIPE_KEY);
        return;
    }
    
    var stripe = Stripe(STRIPE_KEY);
    
    // Discount form AJAX handler
    var discountForm = document.getElementById('discount-form');
    if (discountForm) {
        discountForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            var code = document.getElementById('discount-input').value.trim();
            var btn = document.getElementById('apply-btn');
            var errorEl = document.getElementById('discount-error');
            
            if (!code) return;
            
            btn.disabled = true;
            btn.textContent = 'Applying...';
            errorEl.style.display = 'none';
            
            fetch('/store/apply-discount/' + PRODUCT_ID + '/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: 'discount_code=' + encodeURIComponent(code)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    var section = document.getElementById('discount-section');
                    section.innerHTML = '<div class="discount-success"><i class="fas fa-check-circle"></i><span>Code "' + code + '" applied! (' + data.discount_percent + '% off)</span></div>';
                    
                    var totalsEl = document.getElementById('order-totals');
                    totalsEl.innerHTML = '<div class="total-row subtotal"><span>Subtotal</span><span>$' + ORIGINAL_PRICE.toFixed(2) + '</span></div>' +
                        '<div class="total-row discount-row"><span>Discount</span><span>-$' + data.discount_amount.toFixed(2) + '</span></div>' +
                        '<div class="total-row final"><span class="label">Total</span><span class="value">$' + data.discounted_price.toFixed(2) + '</span></div>';
                } else {
                    errorEl.textContent = data.error || 'Invalid code';
                    errorEl.style.display = 'block';
                    btn.disabled = false;
                    btn.textContent = 'Apply';
                }
            })
            .catch(function(err) {
                errorEl.textContent = 'Error applying code. Please try again.';
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Apply';
            });
        });
    }
    
    // Initialize Stripe checkout
    fetch('/store/create-checkout-session/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify({ product_id: PRODUCT_ID })
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.error) throw new Error(data.error);
        if (!data.clientSecret) throw new Error('No client secret returned');
        document.getElementById('checkout-loading').style.display = 'none';
        return stripe.initEmbeddedCheckout({ clientSecret: data.clientSecret });
    })
    .then(function(checkout) { checkout.mount('#checkout'); })
    .catch(function(error) {
        console.error('Checkout error:', error);
        showError('Error loading checkout: ' + error.message);
    });
})();
</script>
{% endblock %}