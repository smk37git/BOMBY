{% extends 'MAIN/base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/payment.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
{% endblock %}

{% block background %}
    {% include 'MAIN/base_background_starry.html' %}
{% endblock %}

{% block content %}
<div class="product-container">
    <!-- Back link -->
    <div class="product-navigation">
        <a href="{% url 'STORE:store' %}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Store
        </a>
    </div>
    
    <div class="product-card">
        <h1 class="product-title">Complete Your Purchase</h1>
        <hr class="page-divider"></hr>
        
        <div class="product-description">
            <h2>Order Summary</h2>
            <p>Product: {{ product.name }}</p>
            <p>Price: ${{ product.price }}</p>
        </div>
        
        <div class="product-purchase">
            <div class="price-section">
                <div class="price-label">Total:</div>
                <div class="price-value">${{ product.price }}</div>
            </div>
            
            <!-- Simple payment buttons approach -->
            <div class="payment-buttons">
                <!-- PayPal Button -->
                <a href="#" id="paypal-button" class="payment-btn paypal-btn">
                    <i class="fab fa-paypal"></i> Pay with PayPal
                </a>
                
                <!-- Credit Card Button -->
                <a href="#" id="card-button" class="payment-btn card-btn">
                    <i class="fas fa-credit-card"></i> Pay with Card
                </a>
            </div>
            
            <!-- PayPal container (hidden initially) -->
            <div id="paypal-container" style="display:none;">
                <div id="paypal-button-container"></div>
            </div>
        </div>
    </div>
</div>

<!-- PayPal JavaScript SDK (loaded but not initialized until button click) -->
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=USD" data-csp-nonce="xyz"></script>

<script>
    // Get references to elements
    const paypalButton = document.getElementById('paypal-button');
    const cardButton = document.getElementById('card-button');
    const paypalContainer = document.getElementById('paypal-container');
    
    // PayPal button click handler
    paypalButton.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Toggle PayPal container
        if (paypalContainer.style.display === 'none') {
            paypalContainer.style.display = 'block';
            
            // Initialize PayPal buttons only when needed
            paypal.Buttons({
                // Set up the transaction
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: '{{ product.price }}'
                            }
                        }]
                    });
                },
                
                // Finalize the transaction
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(orderData) {
                        // Redirect to success page with payment ID and product ID
                        window.location.href = "{% url 'STORE:payment_success' %}?paymentId=" + 
                            orderData.id + "&product_id={{ product.id }}";
                    });
                },
                
                // Handle errors
                onError: function(err) {
                    console.error('PayPal error:', err);
                    alert('There was an error processing your payment. Please try again.');
                },
                
                // Handle cancellation
                onCancel: function() {
                    window.location.href = "{% url 'STORE:payment_cancel' %}";
                }
            }).render('#paypal-button-container');
        } else {
            paypalContainer.style.display = 'none';
        }
    });
    
    // Credit card button click handler
    cardButton.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = "{% url 'STORE:purchase_product' product.id %}?method=card";
    });
</script>
{% endblock %}