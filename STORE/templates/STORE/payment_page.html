{% extends 'MAIN/base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/payment.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        #checkout { width: 100%; min-height: 400px; }
        .checkout-loading { text-align: center; padding: 40px; color: white; }
        .checkout-loading .spinner { 
            width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%; margin: 0 auto 15px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .checkout-error { color: #ff6b6b; text-align: center; padding: 20px; }
    </style>
{% endblock %}

{% block background %}
    {% include 'MAIN/base_background_starry.html' %}
{% endblock %}

{% block content %}
<div class="product-container">
    <div class="product-navigation">
        <a href="{% url 'STORE:store' %}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Store
        </a>
    </div>
    
    <div class="product-card">
        <h1 class="product-title">Complete Your Purchase</h1>
        <hr class="page-divider">
        
        <div class="product-description">
            <h2>Order Summary</h2>
            <p>Product: {{ product.name }}</p>
            
            {% if user.is_authenticated and not discount_applied %}
                <div class="discount-form">
                    <h3>Have a discount code?</h3>
                    <form method="post" action="{% url 'STORE:apply_discount' product.id %}">
                        {% csrf_token %}
                        <input type="text" name="discount_code" class="discount-input" placeholder="Enter discount code" required>
                        <button type="submit" class="apply-btn">Apply</button>
                    </form>
                    {% if discount_error %}
                        <p class="discount-message" style="color: #ff6b6b;">{{ discount_error }}</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        
        <div class="product-purchase">
            <div class="price-section">
                <div class="price-label">Total:</div>
                <div class="price-value">
                    {% if discount_applied %}
                        <span class="original-price">${{ product.price }}</span>
                        <span class="discounted-price">${{ discounted_price|floatformat:2 }}</span>
                        <div style="font-size: 0.8em; color: #33ffa0;">Discount Applied</div>
                    {% else %}
                        ${{ product.price }}
                    {% endif %}
                </div>
            </div>
            
            <div id="checkout-container">
                <div id="checkout-loading" class="checkout-loading">
                    <div class="spinner"></div>
                    <p>Loading secure checkout...</p>
                </div>
                <div id="checkout"></div>
                <div id="checkout-error" class="checkout-error" style="display:none;"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    var STRIPE_KEY = "{{ stripe_publishable_key }}";
    var CSRF_TOKEN = "{{ csrf_token }}";
    var PRODUCT_ID = "{{ product.id }}";
</script>
<script>
    var stripe = Stripe(STRIPE_KEY);

    async function initCheckout() {
        try {
            var response = await fetch('/store/create-checkout-session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({ product_id: PRODUCT_ID })
            });
            
            var data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            document.getElementById('checkout-loading').style.display = 'none';
            
            var checkout = await stripe.initEmbeddedCheckout({
                clientSecret: data.clientSecret
            });
            
            checkout.mount('#checkout');
            
        } catch (error) {
            console.error('Checkout error:', error);
            document.getElementById('checkout-loading').style.display = 'none';
            document.getElementById('checkout-error').style.display = 'block';
            document.getElementById('checkout-error').textContent = 'Error loading checkout. Please refresh and try again.';
        }
    }

    initCheckout();
</script>
{% endblock %}