{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a; 
            color: #fff; 
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container { max-width: 420px; width: 100%; }
        .card { background: #111; border: 1px solid #222; padding: 24px; margin-bottom: 16px; }
        h1 { font-size: 24px; margin-bottom: 8px; }
        .message { color: #888; font-size: 14px; margin-bottom: 24px; }
        .streamer { color: #635bff; font-weight: 600; }
        
        .amounts { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .amount-btn { 
            flex: 1; min-width: 70px; padding: 12px; 
            background: #1a1a1a; border: 1px solid #333; 
            color: #fff; font-size: 16px; font-weight: 600; cursor: pointer;
            transition: all 0.2s;
        }
        .amount-btn:hover, .amount-btn.selected { background: #635bff; border-color: #635bff; }
        
        .custom-amount { 
            width: 100%; padding: 14px; 
            background: #1a1a1a; border: 1px solid #333; 
            color: #fff; font-size: 18px; margin-bottom: 16px;
        }
        .custom-amount:focus { outline: none; border-color: #635bff; }
        
        .field { margin-bottom: 16px; }
        .field label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; text-transform: uppercase; }
        .field input, .field textarea { 
            width: 100%; padding: 12px; 
            background: #1a1a1a; border: 1px solid #333; 
            color: #fff; font-size: 14px;
        }
        .field textarea { resize: none; height: 80px; }
        
        #card-element { 
            padding: 14px; 
            background: #1a1a1a; border: 1px solid #333; 
            margin-bottom: 16px;
        }
        
        .pay-btn { 
            width: 100%; padding: 16px; 
            background: #635bff; border: none; 
            color: #fff; font-size: 16px; font-weight: 600; 
            cursor: pointer; transition: background 0.2s;
        }
        .pay-btn:hover { background: #7a73ff; }
        .pay-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .error { color: #ff4444; font-size: 14px; margin-bottom: 16px; display: none; }
        .success { text-align: center; padding: 40px 20px; }
        .success h2 { color: #4ade80; margin-bottom: 12px; }
        
        .recent { font-size: 13px; }
        .recent h3 { font-size: 12px; color: #888; margin-bottom: 12px; text-transform: uppercase; }
        .donation-item { 
            display: flex; justify-content: space-between; 
            padding: 10px 0; border-bottom: 1px solid #222;
        }
        .donation-item:last-child { border: none; }
        .donor-name { font-weight: 500; }
        .donation-amount { color: #4ade80; font-weight: 600; }
        
        .powered { text-align: center; font-size: 11px; color: #444; margin-top: 16px; }
        .powered a { color: #635bff; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container" 
         id="donation-container"
         data-stripe-key="{{ stripe_publishable_key }}"
         data-token="{{ token }}"
         data-min-amount="{{ min_amount }}"
         data-streamer="{{ streamer }}"
         data-first-amount="{% firstof suggested_amounts.0 5 %}">
        
        <div class="card" id="form-card">
            <h1>{{ page_title }}</h1>
            <p class="message">{{ page_message }}</p>
            
            <div class="amounts">
                {% for amt in suggested_amounts %}
                <button class="amount-btn" data-amount="{{ amt }}">${{ amt }}</button>
                {% endfor %}
            </div>
            
            <input type="number" class="custom-amount" id="amount" placeholder="Enter amount" min="{{ min_amount }}" step="0.01">
            
            <div class="field">
                <label>Your Name</label>
                <input type="text" id="name" placeholder="Anonymous" maxlength="100">
            </div>
            
            <div class="field">
                <label>Message (optional)</label>
                <textarea id="message" placeholder="Leave a message..." maxlength="500"></textarea>
            </div>
            
            <div id="card-element"></div>
            
            <div class="error" id="error"></div>
            
            <button class="pay-btn" id="pay-btn">
                Donate $<span id="btn-amount">0</span>
            </button>
        </div>
        
        <div class="card success" id="success-card" style="display:none;">
            <h2>âœ“ Thank You!</h2>
            <p>Your donation to <span class="streamer">{{ streamer }}</span> was successful.</p>
        </div>
        
        {% if recent_donations %}
        <div class="card recent">
            <h3>Recent Donations</h3>
            {% for d in recent_donations %}
            <div class="donation-item">
                <span class="donor-name">{{ d.donor_name }}</span>
                <span class="donation-amount">{{ d.currency }} {{ d.amount }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <div class="powered">Powered by <a href="https://bomby.us" target="_blank">Bomby</a></div>
    </div>

    <script>
        (function() {
            var container = document.getElementById('donation-container');
            var config = {
                stripeKey: container.dataset.stripeKey,
                token: container.dataset.token,
                minAmount: parseFloat(container.dataset.minAmount) || 1,
                firstAmount: parseFloat(container.dataset.firstAmount) || 5
            };
            
            var stripe = Stripe(config.stripeKey);
            var elements = stripe.elements();
            var card = elements.create('card', {
                style: {
                    base: { color: '#fff', fontSize: '16px', '::placeholder': { color: '#666' } },
                    invalid: { color: '#ff4444' }
                }
            });
            card.mount('#card-element');
            
            var amountInput = document.getElementById('amount');
            var btnAmount = document.getElementById('btn-amount');
            var payBtn = document.getElementById('pay-btn');
            var errorEl = document.getElementById('error');
            
            amountInput.value = config.firstAmount;
            btnAmount.textContent = config.firstAmount;
            
            document.querySelectorAll('.amount-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.amount-btn').forEach(function(b) { 
                        b.classList.remove('selected'); 
                    });
                    btn.classList.add('selected');
                    amountInput.value = btn.dataset.amount;
                    btnAmount.textContent = btn.dataset.amount;
                });
            });
            
            amountInput.addEventListener('input', function() {
                document.querySelectorAll('.amount-btn').forEach(function(b) { 
                    b.classList.remove('selected'); 
                });
                btnAmount.textContent = amountInput.value || '0';
            });
            
            payBtn.addEventListener('click', async function() {
                var amount = parseFloat(amountInput.value);
                if (!amount || amount < config.minAmount) {
                    errorEl.textContent = 'Minimum donation is $' + config.minAmount;
                    errorEl.style.display = 'block';
                    return;
                }
                
                payBtn.disabled = true;
                payBtn.textContent = 'Processing...';
                errorEl.style.display = 'none';
                
                try {
                    var res = await fetch('/fuzeobs/donate/' + config.token + '/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            amount: amount,
                            name: document.getElementById('name').value || 'Anonymous',
                            message: document.getElementById('message').value
                        })
                    });
                    
                    var data = await res.json();
                    if (data.error) throw new Error(data.error);
                    
                    var result = await stripe.confirmCardPayment(data.client_secret, {
                        payment_method: { card: card }
                    });
                    
                    if (result.error) throw new Error(result.error.message);
                    
                    if (result.paymentIntent.status === 'succeeded') {
                        await fetch('/fuzeobs/donate/' + config.token + '/confirm', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ payment_intent: result.paymentIntent.id })
                        });
                        
                        document.getElementById('form-card').style.display = 'none';
                        document.getElementById('success-card').style.display = 'block';
                    }
                } catch (e) {
                    errorEl.textContent = e.message;
                    errorEl.style.display = 'block';
                    payBtn.disabled = false;
                    payBtn.innerHTML = 'Donate $<span id="btn-amount">' + amount + '</span>';
                }
            });
            
            var firstBtn = document.querySelector('.amount-btn');
            if (firstBtn) firstBtn.click();
        })();
    </script>
</body>
</html>