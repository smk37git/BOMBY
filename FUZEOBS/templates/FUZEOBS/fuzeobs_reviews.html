{% extends 'MAIN/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/fuzeobs_analytics.css' %}">
<link rel="stylesheet" href="{% static 'css/fuzeobs_reviews.css' %}">
{% endblock %}

{% block background %}
{% include 'MAIN/base_background.html' %}
{% endblock %}

{% block content %}
<h1 class="user_management-title">FuzeOBS Reviews</h1>

<div class="analytics-container">
    <div class="analytics-nav">
        <a href="{% url 'FUZEOBS:analytics' %}" class="nav-tab">Analytics</a>
        <a href="{% url 'FUZEOBS:reviews_admin' %}" class="nav-tab active">Reviews</a>
    </div>

    <div class="analytics-header">
        <h2>Review Management</h2>
        <button class="btn-primary" onclick="openCreateModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add Review
        </button>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">Total Reviews</div>
            <div class="metric-value">{{ total_reviews }}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Featured</div>
            <div class="metric-value" style="color: #4ade80;">{{ featured_count }}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Average Rating</div>
            <div class="metric-value">{{ avg_rating|floatformat:1 }}/5</div>
        </div>
    </div>

    <div class="analytics-section">
        <div class="section-header">
            <h3>All Reviews</h3>
        </div>
        <table class="product-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Platform</th>
                    <th>Rating</th>
                    <th>Review</th>
                    <th>Featured</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for review in reviews %}
                <tr id="review-{{ review.id }}">
                    <td>
                        <div class="review-user">
                            {% if review.user.profile_picture %}
                            <img src="{{ review.user.profile_picture.url }}" class="review-avatar" alt="">
                            {% else %}
                            <div class="review-avatar-placeholder">{{ review.user.username|slice:":1"|upper }}</div>
                            {% endif %}
                            <span>{{ review.user.username }}</span>
                        </div>
                    </td>
                    <td><span class="platform-badge platform-{{ review.platform }}">{{ review.platform|upper }}</span></td>
                    <td class="rating-stars">{{ review.rating }}/5</td>
                    <td class="review-text">{{ review.review|truncatechars:80 }}</td>
                    <td>
                        <label class="toggle-switch">
                            <input type="checkbox" {% if review.featured %}checked{% endif %} data-review-id="{{ review.id }}" onchange="toggleFeatured(this.dataset.reviewId, this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </td>
                    <td>{{ review.created_at|date:"M d, Y" }}</td>
                    <td>
                        <button class="btn-danger btn-sm" data-review-id="{{ review.id }}" onclick="deleteReview(this.dataset.reviewId)">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: rgba(255,255,255,0.4);">No reviews yet</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create Review Modal -->
<div id="createModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Review</h3>
            <button onclick="closeCreateModal()" class="modal-close">&times;</button>
        </div>
        <form id="createReviewForm">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="createUsername" required placeholder="Enter username...">
            </div>
            <div class="form-group">
                <label>Platform</label>
                <select id="createPlatform" required>
                    <option value="twitch">Twitch</option>
                    <option value="youtube">YouTube</option>
                    <option value="kick">Kick</option>
                    <option value="tiktok">TikTok</option>
                    <option value="facebook">Facebook</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Rating</label>
                <div class="star-input" id="starInput"></div>
                <input type="hidden" id="createRating" value="5">
            </div>
            <div class="form-group">
                <label>Review</label>
                <textarea id="createReview" required maxlength="300" rows="4" placeholder="Write review..."></textarea>
                <span class="char-count"><span id="charCount">0</span>/300</span>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="createFeatured">
                    Featured on landing page
                </label>
            </div>
            <div class="modal-actions">
                <button type="button" onclick="closeCreateModal()" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn-primary">Create Review</button>
            </div>
        </form>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function toggleFeatured(reviewId, featured) {
    try {
        const res = await fetch('{% url "FUZEOBS:toggle_review_featured" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ review_id: reviewId, featured: featured })
        });
        if (!res.ok) throw new Error('Failed');
    } catch (e) {
        alert('Failed to update');
        location.reload();
    }
}

async function deleteReview(reviewId) {
    if (!confirm('Delete this review?')) return;
    
    try {
        const res = await fetch('{% url "FUZEOBS:delete_review" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ review_id: reviewId })
        });
        if (res.ok) {
            document.getElementById('review-' + reviewId).remove();
        } else {
            throw new Error('Failed');
        }
    } catch (e) {
        alert('Failed to delete');
    }
}

function openCreateModal() {
    document.getElementById('createModal').style.display = 'flex';
}

function closeCreateModal() {
    document.getElementById('createModal').style.display = 'none';
    document.getElementById('createReviewForm').reset();
    setRating(5);
}

function setRating(rating) {
    document.getElementById('createRating').value = rating;
    document.querySelectorAll('.star-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i < rating);
    });
}

// Build star buttons via JS to avoid encoding issues
(function() {
    const container = document.getElementById('starInput');
    for (let i = 1; i <= 5; i++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'star-btn';
        btn.dataset.rating = i;
        btn.innerHTML = '&#9733;';
        btn.onclick = function() { setRating(i); };
        container.appendChild(btn);
    }
})();

document.getElementById('createReview').addEventListener('input', function() {
    document.getElementById('charCount').textContent = this.value.length;
});

document.getElementById('createReviewForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const data = {
        username: document.getElementById('createUsername').value,
        platform: document.getElementById('createPlatform').value,
        rating: parseInt(document.getElementById('createRating').value),
        review: document.getElementById('createReview').value,
        featured: document.getElementById('createFeatured').checked
    };
    
    try {
        const res = await fetch('{% url "FUZEOBS:create_review_admin" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
            location.reload();
        } else {
            alert(result.error || 'Failed to create review');
        }
    } catch (e) {
        alert('Failed to create review');
    }
});

setRating(5);
</script>
{% endblock %}