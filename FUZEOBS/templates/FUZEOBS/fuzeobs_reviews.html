{% extends 'MAIN/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/fuzeobs_analytics.css' %}">
<link rel="stylesheet" href="{% static 'css/fuzeobs_reviews.css' %}">
{% endblock %}

{% block background %}
{% include 'MAIN/base_background.html' %}
{% endblock %}

{% block content %}
<h1 class="user_management-title">FuzeOBS Reviews</h1>

<div class="analytics-container">
    <div class="analytics-header">
        <h2>Review Management</h2>
        <div class="time-filter">
            <a href="{% url 'FUZEOBS:analytics' %}">Analytics</a>
            <a href="#" class="active" id="addReviewBtn">+ Add Review</a>
        </div>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">Total Reviews</div>
            <div class="metric-value">{{ total_reviews }}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Featured</div>
            <div class="metric-value" style="color: #4ade80;">{{ featured_count }}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Average Rating</div>
            <div class="metric-value">{{ avg_rating|floatformat:1 }}/5</div>
        </div>
    </div>

    <div class="analytics-section">
        <div class="section-header">
            <h3>All Reviews</h3>
        </div>
        <table class="product-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Platform</th>
                    <th>Rating</th>
                    <th>Review</th>
                    <th>Featured</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for review in reviews %}
                <tr id="review-{{ review.id }}">
                    <td>
                        <div class="review-user">
                            {% if review.user.profile_picture %}
                            <img src="{{ review.user.profile_picture.url }}" class="review-avatar" alt="">
                            {% else %}
                            <div class="review-avatar-placeholder">{{ review.user.username|slice:":1"|upper }}</div>
                            {% endif %}
                            <span>{{ review.user.username }}</span>
                        </div>
                    </td>
                    <td><span class="platform-badge platform-{{ review.platform }}">{{ review.platform|upper }}</span></td>
                    <td class="rating-stars">{{ review.rating }}/5</td>
                    <td class="review-text">{{ review.review|truncatechars:80 }}</td>
                    <td>
                        <label class="toggle-switch">
                            <input type="checkbox" {% if review.featured %}checked{% endif %} data-review-id="{{ review.id }}" class="toggle-featured">
                            <span class="toggle-slider"></span>
                        </label>
                    </td>
                    <td>{{ review.created_at|date:"M d, Y" }}</td>
                    <td>
                        <button class="btn-edit btn-sm edit-review-btn" data-review-id="{{ review.id }}" data-platform="{{ review.platform }}" data-rating="{{ review.rating }}" data-review="{{ review.review|escapejs }}" data-featured="{% if review.featured %}true{% else %}false{% endif %}">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="btn-danger btn-sm delete-review-btn" data-review-id="{{ review.id }}">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: rgba(255,255,255,0.4);">No reviews yet</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create Review Modal -->
<div id="createModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Review</h3>
            <button id="closeModalBtn" class="modal-close">&times;</button>
        </div>
        <form id="createReviewForm">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="createUsername" required placeholder="Enter username...">
            </div>
            <div class="form-group">
                <label>Platform</label>
                <select id="createPlatform" required>
                    <option value="twitch">Twitch</option>
                    <option value="youtube">YouTube</option>
                    <option value="kick">Kick</option>
                    <option value="tiktok">TikTok</option>
                    <option value="facebook">Facebook</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Rating</label>
                <div class="star-input" id="starInput"></div>
                <input type="hidden" id="createRating" value="5">
            </div>
            <div class="form-group">
                <label>Review</label>
                <textarea id="createReview" required maxlength="300" rows="3" placeholder="Write review..."></textarea>
                <span class="char-count"><span id="charCount">0</span>/300</span>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="createFeatured">
                    Featured on landing page
                </label>
            </div>
            <div class="modal-actions">
                <button type="button" id="cancelModalBtn" class="modal-btn">Cancel</button>
                <button type="submit" class="modal-btn modal-btn-primary">Create Review</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Review Modal -->
<div id="editModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Review</h3>
            <button id="closeEditModalBtn" class="modal-close">&times;</button>
        </div>
        <form id="editReviewForm">
            <input type="hidden" id="editReviewId">
            <div class="form-group">
                <label>Platform</label>
                <select id="editPlatform" required>
                    <option value="twitch">Twitch</option>
                    <option value="youtube">YouTube</option>
                    <option value="kick">Kick</option>
                    <option value="tiktok">TikTok</option>
                    <option value="facebook">Facebook</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Rating</label>
                <div class="star-input" id="editStarInput"></div>
                <input type="hidden" id="editRating" value="5">
            </div>
            <div class="form-group">
                <label>Review</label>
                <textarea id="editReviewText" required maxlength="300" rows="3" placeholder="Write review..."></textarea>
                <span class="char-count"><span id="editCharCount">0</span>/300</span>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="editFeatured">
                    Featured on landing page
                </label>
            </div>
            <div class="modal-actions">
                <button type="button" id="cancelEditModalBtn" class="modal-btn">Cancel</button>
                <button type="submit" class="modal-btn modal-btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    var toggleFeaturedUrl = '{% url "FUZEOBS:toggle_review_featured" %}';
    var deleteReviewUrl = '{% url "FUZEOBS:delete_review" %}';
    var createReviewUrl = '{% url "FUZEOBS:create_review_admin" %}';
    var editReviewUrl = '{% url "FUZEOBS:edit_review_admin" %}';
    
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function toggleFeatured(reviewId, featured) {
        fetch(toggleFeaturedUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ review_id: reviewId, featured: featured })
        }).then(function(res) {
            if (!res.ok) {
                alert('Failed to update');
                location.reload();
            }
        }).catch(function() {
            alert('Failed to update');
            location.reload();
        });
    }

    function deleteReview(reviewId) {
        if (!confirm('Delete this review?')) return;
        
        fetch(deleteReviewUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ review_id: reviewId })
        }).then(function(res) {
            if (res.ok) {
                var row = document.getElementById('review-' + reviewId);
                if (row) row.remove();
            } else {
                alert('Failed to delete');
            }
        }).catch(function() {
            alert('Failed to delete');
        });
    }

    function openCreateModal() {
        document.getElementById('createModal').style.display = 'flex';
    }

    function closeCreateModal() {
        document.getElementById('createModal').style.display = 'none';
        document.getElementById('createReviewForm').reset();
        setRating(5);
    }

    function setRating(rating) {
        document.getElementById('createRating').value = rating;
        var btns = document.querySelectorAll('.star-btn');
        for (var i = 0; i < btns.length; i++) {
            if (i < rating) {
                btns[i].classList.add('active');
            } else {
                btns[i].classList.remove('active');
            }
        }
    }

    // Build star buttons
    var container = document.getElementById('starInput');
    for (var i = 1; i <= 5; i++) {
        (function(rating) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'star-btn';
            btn.innerHTML = '&#9733;';
            btn.addEventListener('click', function() { setRating(rating); });
            container.appendChild(btn);
        })(i);
    }

    // Event listeners
    document.getElementById('addReviewBtn').addEventListener('click', function(e) {
        e.preventDefault();
        openCreateModal();
    });
    
    document.getElementById('closeModalBtn').addEventListener('click', closeCreateModal);
    document.getElementById('cancelModalBtn').addEventListener('click', closeCreateModal);

    document.querySelectorAll('.toggle-featured').forEach(function(el) {
        el.addEventListener('change', function() {
            toggleFeatured(this.dataset.reviewId, this.checked);
        });
    });

    document.querySelectorAll('.delete-review-btn').forEach(function(el) {
        el.addEventListener('click', function() {
            deleteReview(this.dataset.reviewId);
        });
    });

    document.getElementById('createReview').addEventListener('input', function() {
        document.getElementById('charCount').textContent = this.value.length;
    });

    document.getElementById('createReviewForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var data = {
            username: document.getElementById('createUsername').value,
            platform: document.getElementById('createPlatform').value,
            rating: parseInt(document.getElementById('createRating').value),
            review: document.getElementById('createReview').value,
            featured: document.getElementById('createFeatured').checked
        };
        
        fetch(createReviewUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        }).then(function(res) {
            return res.json();
        }).then(function(result) {
            if (result.success) {
                location.reload();
            } else {
                alert(result.error || 'Failed to create review');
            }
        }).catch(function() {
            alert('Failed to create review');
        });
    });

    // Edit modal functions
    var editingReviewId = null;

    function setEditRating(rating) {
        document.getElementById('editRating').value = rating;
        var btns = document.querySelectorAll('#editStarInput .star-btn');
        for (var i = 0; i < btns.length; i++) {
            if (i < rating) {
                btns[i].classList.add('active');
            } else {
                btns[i].classList.remove('active');
            }
        }
    }

    function openEditModal(btn) {
        editingReviewId = btn.dataset.reviewId;
        document.getElementById('editReviewId').value = editingReviewId;
        document.getElementById('editPlatform').value = btn.dataset.platform;
        document.getElementById('editReviewText').value = btn.dataset.review;
        document.getElementById('editCharCount').textContent = btn.dataset.review.length;
        document.getElementById('editFeatured').checked = btn.dataset.featured === 'true';
        setEditRating(parseInt(btn.dataset.rating));
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        editingReviewId = null;
    }

    // Build edit star buttons
    var editContainer = document.getElementById('editStarInput');
    for (var j = 1; j <= 5; j++) {
        (function(rating) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'star-btn';
            btn.innerHTML = '&#9733;';
            btn.addEventListener('click', function() { setEditRating(rating); });
            editContainer.appendChild(btn);
        })(j);
    }

    document.getElementById('closeEditModalBtn').addEventListener('click', closeEditModal);
    document.getElementById('cancelEditModalBtn').addEventListener('click', closeEditModal);

    document.getElementById('editReviewText').addEventListener('input', function() {
        document.getElementById('editCharCount').textContent = this.value.length;
    });

    document.querySelectorAll('.edit-review-btn').forEach(function(el) {
        el.addEventListener('click', function() {
            openEditModal(this);
        });
    });

    document.getElementById('editReviewForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var data = {
            review_id: parseInt(document.getElementById('editReviewId').value),
            platform: document.getElementById('editPlatform').value,
            rating: parseInt(document.getElementById('editRating').value),
            review: document.getElementById('editReviewText').value,
            featured: document.getElementById('editFeatured').checked
        };
        
        fetch(editReviewUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        }).then(function(res) {
            return res.json();
        }).then(function(result) {
            if (result.success) {
                location.reload();
            } else {
                alert(result.error || 'Failed to update review');
            }
        }).catch(function() {
            alert('Failed to update review');
        });
    });

    setRating(5);
})();
</script>
{% endblock %}