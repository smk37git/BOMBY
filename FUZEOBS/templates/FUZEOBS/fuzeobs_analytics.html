{% extends 'MAIN/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/fuzeobs_analytics.css' %}">
<style>
    .tier-free { background: #ff3f3f; padding: 4px 12px; border-radius: 4px; }
    .tier-pro { background: #ffc824; padding: 4px 12px; border-radius: 4px; }
    .tier-lifetime { background: #33ffa0; padding: 4px 12px; border-radius: 4px; }
    .platform-windows { background: #3bf644; }
    .platform-mac { background: #6b8dc2; }
    .platform-linux { background: #f59e0b; }
    .view-link { color: #a855f7; text-decoration: none; font-weight: bold; }
    .view-link:hover { color: #c084fc; text-decoration: underline; }
</style>
{% endblock %}

{% block background %}
    {% include 'MAIN/base_background.html' %}
{% endblock %}

{% block content %}
<h1 class="user_management-title" style="margin: 50px auto;">FuzeOBS Analytics Dashboard</h1>

<div class="analytics-container">
    <div class="analytics-header">
        <h2>Performance Dashboard</h2>
        <div class="time-filter">
            <a href="?days=7" class="{% if days == 7 %}active{% endif %}">Last 7 days</a>
            <a href="?days=30" class="{% if days == 30 %}active{% endif %}">Last 30 days</a>
            <a href="?days=90" class="{% if days == 90 %}active{% endif %}">Last 90 days</a>
            <a href="?days=365" class="{% if days == 365 %}active{% endif %}">Last year</a>
        </div>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">Total Users</div>
            <div class="metric-value">{{ total_users }}</div>
            <div class="metric-subtext">FuzeOBS activated accounts</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Active Users</div>
            <div class="metric-value">{{ active_users }}</div>
            <div class="metric-subtext">Currently logged in</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Total Downloads</div>
            <div class="metric-value">{{ total_downloads }}</div>
            <div class="metric-subtext">All platforms</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Avg Response Time</div>
            <div class="metric-value">{{ avg_response_time }}s</div>
            <div class="metric-subtext">AI request latency</div>
        </div>
    </div>

    <div class="analytics-section">
        <div class="section-header">
            <h3>AI Usage & Cost Analysis</h3>
        </div>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total AI Cost</div>
                <div class="metric-value">${{ total_cost }}</div>
                <div class="metric-subtext">{{ total_requests }} requests</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Free Users Cost</div>
                <div class="metric-value" style="color: #ff3f3f;">${{ free_cost }}</div>
                <div class="metric-subtext">{{ free_requests }} requests</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Paid Users Cost</div>
                <div class="metric-value" style="color: #33ffa0;">${{ paid_cost }}</div>
                <div class="metric-subtext">{{ paid_requests }} requests</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Success Rate</div>
                <div class="metric-value">{{ success_rate }}%</div>
                <div class="metric-subtext">{{ error_rate }}% error rate</div>
            </div>
        </div>
    </div>

    <div class="analytics-section">
        <div class="section-header">
            <h3>All FuzeOBS Users - Ranked by AI Usage</h3>
        </div>
        <table class="product-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Username</th>
                    <th>Tier</th>
                    <th>AI Requests</th>
                    <th>Total Cost</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for u in top_users %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ u.user__username }}</td>
                    <td><span class="tier-{{ u.user__fuzeobs_tier }}">{{ u.user__fuzeobs_tier|upper }}</span></td>
                    <td>{{ u.total_requests }}</td>
                    <td>${{ u.total_cost|floatformat:4 }}</td>
                    <td><a href="{% url 'FUZEOBS:user_detail' u.user__id %}" class="view-link">View Details â†’</a></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; color: #666;">No FuzeOBS users yet</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="analytics-section">
        <div class="section-header">
            <h3>Downloads by Platform</h3>
        </div>
        <div class="pie-container">
            <div class="pie-chart" id="downloadsPieChart"></div>
            <div class="pie-legend">
                {% for d in downloads_by_platform %}
                <div class="pie-item">
                    <div class="pie-color platform-{{ d.platform }}"></div>
                    <span>{{ d.platform|title }}: {{ d.count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="analytics-section">
        <div class="section-header">
            <h3>User Tier Distribution</h3>
        </div>
        <div class="pie-container">
            <div class="pie-chart" id="tiersPieChart"></div>
            <div class="pie-legend">
                {% for t in tier_distribution %}
                <div class="pie-item">
                    <div class="pie-color tier-{{ t.tier }}"></div>
                    <span>{{ t.tier|title }}: {{ t.count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const downloadsData = JSON.parse('{{ downloads_json|escapejs }}');
    const downloadsTotal = downloadsData.reduce((sum, d) => sum + d.count, 0);
    const downloadsChart = document.getElementById('downloadsPieChart');
    
    if (downloadsTotal > 0 && downloadsChart) {
        let gradientStr = 'conic-gradient(';
        let cumulative = 0;
        const colors = {'windows': '#3b82f6', 'mac': '#10b981', 'linux': '#f59e0b'};
        
        downloadsData.forEach((d, i) => {
            const percent = (d.count / downloadsTotal * 100);
            const color = colors[d.platform] || '#999';
            gradientStr += `${color} ${cumulative}% ${cumulative + percent}%`;
            cumulative += percent;
            if (i < downloadsData.length - 1) gradientStr += ', ';
        });
        
        gradientStr += ')';
        downloadsChart.style.background = gradientStr;
    }
    
    const tiersData = JSON.parse('{{ tier_distribution_json|escapejs }}');
    const tiersTotal = tiersData.reduce((sum, t) => sum + t.count, 0);
    const tiersChart = document.getElementById('tiersPieChart');
    
    if (tiersTotal > 0 && tiersChart) {
        let gradientStr = 'conic-gradient(';
        let cumulative = 0;
        const colors = {'free': '#ff3f3f', 'pro': '#ffc824', 'lifetime': '#33ffa0'};
        
        tiersData.forEach((t, i) => {
            const percent = (t.count / tiersTotal * 100);
            const color = colors[t.tier] || '#999';
            gradientStr += `${color} ${cumulative}% ${cumulative + percent}%`;
            cumulative += percent;
            if (i < tiersData.length - 1) gradientStr += ', ';
        });
        
        gradientStr += ')';
        tiersChart.style.background = gradientStr;
    }
});
</script>
{% endblock %}